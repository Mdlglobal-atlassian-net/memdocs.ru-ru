---
title: Обслуживание обновлений программного обеспечения
titleSuffix: Configuration Manager
description: Для обслуживания обновлений в Configuration Manager можно запланировать автоматический запуск задач очистки WSUS или выполнить ее вручную.
author: mestew
ms.date: 12/17/2019
ms.topic: conceptual
ms.prod: configuration-manager
ms.technology: configmgr-sum
ms.assetid: 4b0e2e90-aac7-4d06-a707-512eee6e576c
manager: dougeby
ms.author: mstewart
ms.openlocfilehash: 560b432bb90f99207fd15bc07e7aff98ffd59ebf
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81703012"
---
# <a name="software-updates-maintenance"></a>Обслуживание обновлений программного обеспечения

*Область применения: Configuration Manager (Current Branch)*

Задачи очистки WSUS можно запланировать и выполнить из консоли Configuration Manager в свойствах компонента точки обновления программного обеспечения. При первом выборе задания очистки WSUS для запуска оно будет выполнено после следующей синхронизации обновлений программного обеспечения.  

## <a name="to-schedule-and-run-the-wsus-cleanup-job"></a>Планирование и запуск задания очистки WSUS

Чтобы запланировать задание очистки WSUS, выполните следующие действия:

1. В консоли Configuration Manager перейдите в раздел **Администрирование** > **Обзор** > **Конфигурация сайта** > **Сайты**.
2. Выберите сайт в верхней части иерархии Configuration Manager.

3. Щелкните **Настройка компонентов сайта** в группе **Параметры** и затем щелкните **Точка обновления программного обеспечения** , чтобы открыть свойства компонента точки обновления программного обеспечения.  

4. Проверьте параметр **Поведение замены**. При необходимости измените поведение.

   ![снимок экрана с поведением замены](media/supersedence-behavior.png)

5. Выберите вкладку **Правила замены**, а затем **Запустить мастер очистки WSUS**. В версии 1806 параметр переименован в **Запуск очистки WSUS после синхронизации**.

6. Нажмите кнопку **ОК** (в версии 1806 нажмите кнопку **Закрыть**).

## <a name="wsus-cleanup-behavior-in-version-1802-and-earlier"></a>Поведение очистки WSUS в версии 1802 и более ранних

До версии 1806 Configuration Manager очистка WSUS запускает следующий элемент.

- Параметр **Просроченные обновления** мастера очистки WSUS доступен только на сервере WSUS сайта верхнего уровня.

  ![снимок экрана с очисткой просроченных обновлений WSUS](media/wsus-cleanup-expired.PNG)

- Очистка элементов конфигурации обновления программного обеспечения в базе данных Configuration Manager происходит каждые семь дней и удаляет ненужные обновления из консоли.
  - Эта очистка не удаляет просроченные обновления из консоли Configuration Manager, если они развернуты в настоящее время.

По-прежнему необходимо дополнительное обслуживание базы данных WSUS верхнего уровня и всех остальных баз данных WSUS в среде. Дополнительные сведения и инструкции см. в записи блога [The complete guide to Microsoft WSUS and Configuration Manager SUP maintenance](https://support.microsoft.com/help/4490644/complete-guide-to-microsoft-wsus-and-configuration-manager-sup-maint/) (Полное руководство по обслуживанию Microsoft WSUS и точек обновления ПО Configuration Manager).

## <a name="wsus-cleanup-behavior-starting-in-version-1806"></a>Поведение очистки WSUS, начиная с версии 1806

Начиная с версии 1806, очистка WSUS происходит после каждой синхронизации и при этом выполняются следующие этапы очистки:
<!--1357898 -->

- Параметр **Просроченные обновления** для серверов WSUS на сайте центра администрирования и первичных сайтах.
  - Серверы WSUS для вторичных сайтов не выполняют очистку просроченных обновлений.
- Configuration Manager составляет список заменяемых обновлений из своей базы данных. Список строится в соответствии с поведением замены, установленным в настройках компонента точки обновления программного обеспечения.
  - Элементы конфигурации обновления, удовлетворяющие критериям поведения замены, считаются просроченными в консоли Configuration Manager.
  - Эти обновления отклоняются в WSUS для сайта центра администрирования и первичных сайтов, но не для вторичных сайтов.
- Очистка элементов конфигурации обновления программного обеспечения в базе данных Configuration Manager происходит каждые семь дней и удаляет ненужные обновления из консоли.
  - Эта очистка не удаляет просроченные обновления из консоли Configuration Manager, если они развернуты в настоящее время.

> [!NOTE]
> "Месяцы ожидания до истечения срока действия заменяемого обновления" связаны с датой создания заменяющего обновления. Например, если для этого параметра задано значение 2 месяца, замененные обновления будут отклонены в службах WSUS и станут просроченными в Configuration Manager, когда с момента выхода заменяющего обновления пройдет 2 месяца.

На вторичных базах данных WSUS все обслуживание необходимо запускать вручную. Следующие параметры **мастера очистки сервера WSUS** недоступны на сайте центра администрирования и первичных сайтах:

- Неиспользуемые обновления и редакции обновлений
- Компьютеры, не взаимодействующие с сервером
- Ненужные файлы обновлений

  Дополнительные сведения и инструкции см. в записи блога [The complete guide to Microsoft WSUS and Configuration Manager SUP maintenance](https://support.microsoft.com/help/4490644/complete-guide-to-microsoft-wsus-and-configuration-manager-sup-maint/) (Полное руководство по обслуживанию Microsoft WSUS и точек обновления ПО Configuration Manager).

## <a name="wsus-cleanup-behavior-starting-in-version-1810"></a>Поведение очистки WSUS, начиная с версии 1810

Начиная с версии 1810 вы можете задать правила замены для обновления компонентов отдельно от обновлений, не связанных с компонентами, в свойствах компонента точки обновления программного обеспечения. Очистка WSUS происходит после каждой синхронизации, и при этом выполняются следующие этапы очистки:
<!--2839349,3098809, 2977644-->

- Параметр **Просроченные обновления** для серверов WSUS на сайте центра администрирования, первичных и вторичных сайтах.
- Configuration Manager составляет список заменяемых обновлений из своей базы данных. Список строится в соответствии с поведением замены, установленным в настройках компонента точки обновления программного обеспечения.
  - Элементы конфигурации обновления, удовлетворяющие критериям поведения замены, считаются просроченными в консоли Configuration Manager.
  - Эти обновления отклоняются в WSUS для сайта центра администрирования, первичных и вторичных сайтов.
- Очистка элементов конфигурации обновления программного обеспечения в базе данных Configuration Manager происходит каждые семь дней и удаляет ненужные обновления из консоли.
  - Эта очистка не удаляет просроченные обновления из консоли Configuration Manager, если они развернуты в настоящее время.

> [!NOTE]
> "Месяцы ожидания до истечения срока действия заменяемого обновления" связаны с датой создания заменяющего обновления. Например, если для этого параметра задано значение 2 месяца, замененные обновления будут отклонены в службах WSUS и станут просроченными в Configuration Manager, когда с момента выхода заменяющего обновления пройдет 2 месяца.

Следующие параметры **мастера очистки сервера WSUS** недоступны на сайте центра администрирования, первичных и вторичных сайтах:

- Неиспользуемые обновления и редакции обновлений
- Компьютеры, не взаимодействующие с сервером
- Ненужные файлы обновлений

  Дополнительные сведения и инструкции см. в записи блога [The complete guide to Microsoft WSUS and Configuration Manager SUP maintenance](https://support.microsoft.com/help/4490644/complete-guide-to-microsoft-wsus-and-configuration-manager-sup-maint/) (Полное руководство по обслуживанию Microsoft WSUS и точек обновления ПО Configuration Manager).

## <a name="wsus-cleanup-starting-in-version-1906"></a>Очистка WSUS начиная с версии 1906
<!--41101009-->

 У вас есть дополнительные задачи обслуживания WSUS, которые Configuration Manager может выполнять, чтобы поддерживать работоспособность точек обновления программного обеспечения. Помимо отклонения обновлений с истекшим сроком действия в WSUS, Configuration Manager теперь может добавлять некластеризованные индексы в базу данных WSUS и удалять устаревшие обновления из баз данных WSUS. Обслуживание WSUS происходит после каждой синхронизации.

### <a name="decline-expired-updates-in-wsus-according-to-supersedence-rules"></a>Отклонение просроченных обновлений в WSUS в соответствии с правилами замены

Отклонение обновлений в WSUS повышает производительность за счет удаления этих обновлений из каталогов, отправляемых клиентам. Отклонение обновлений, которые Configuration Manager помечает как замененные, дополнительно уменьшает размер каталогов и повышает производительность.

1. В консоли Configuration Manager перейдите в раздел **Администрирование** > **Обзор** > **Конфигурация сайта** > **Сайты**.
2. Выберите сайт в верхней части иерархии Configuration Manager.
3. Щелкните **Настройка компонентов сайта** в группе "Параметры", а затем **Точка обновления программного обеспечения**, чтобы открыть свойства компонента точки обновления программного обеспечения.
4. На вкладке **WSUS Maintenance** (Обслуживание WSUS) установите флажок **Decline expired updates in WSUS according to supersedence rules** (Отклонять просроченные обновления в WSUS в соответствии с правилами замены).

### <a name="add-non-clustered-indexes-to-the-wsus-database-to-improve-wsus-cleanup-performance"></a>Добавление некластеризованных индексов в базу данных WSUS для улучшения производительности очистки WSUS

Добавление некластеризованных индексов повышает производительность очистки WSUS, выполняемой Configuration Manager.

1. В консоли Configuration Manager перейдите в раздел **Администрирование** > **Обзор** > **Конфигурация сайта** > **Сайты**.
2. Выберите сайт в верхней части иерархии Configuration Manager.
3. Щелкните **Настройка компонентов сайта** в группе "Параметры", а затем **Точка обновления программного обеспечения**, чтобы открыть свойства компонента точки обновления программного обеспечения.
4. На вкладке **Обслуживание WSUS** (Обслуживание WSUS) выберите **Add non-clustered indexes to the WSUS database** (Добавить некластеризованные индексы в базу данных WSUS).
5. В каждой базе данных SUSDB, используемой Configuration Manager, индексы добавляются в следующие таблицы:
   - tbLocalizedPropertyForRevision;
   - tbRevisionSupersedesUpdate.

#### <a name="sql-permissions-for-creating-indexes"></a>Разрешения SQL для создания индексов

Если база данных WSUS находится на удаленном сервере SQL Server, может потребоваться добавить разрешения в SQL для создания индексов. Учетная запись, используемая для подключения к базе данных WSUS и создания индексов, может быть различной. Если вы указываете в [свойствах точки обновления программного обеспечения учетную запись подключения к серверу WSUS](../get-started/install-a-software-update-point.md#wsus-server-connection-account), убедитесь, что учетная запись подключения имеет разрешения SQL. Если учетная запись подключения к серверу WSUS не указана, то учетной записи компьютера сервера сайта требуются разрешения SQL.

- Для создания индекса требуется разрешение `ALTER` для таблицы или представления. Учетная запись должна быть членом предопределенной роли сервера `sysadmin` или предопределенных ролей базы данных `db_ddladmin` и `db_owner`. См. подробнее о создании индексов и разрешений в разделе [CREATE INDEX (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/create-index-transact-sql?view=sql-server-2017#permissions).
- Необходимо предоставить разрешение сервера `CONNECT SQL` для учетной записи. См. подробнее о [предоставлении разрешении сервера (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/grant-server-permissions-transact-sql?view=sql-server-2017).

> [!NOTE]  
>  Если база данных WSUS находится на удаленном сервере SQL, использующем порт не по умолчанию, индексы могут не добавиться. Для этого сценария можно создать псевдоним сервера [с помощью диспетчера конфигурации SQL Server](https://docs.microsoft.com/sql/database-engine/configure-windows/create-or-delete-a-server-alias-for-use-by-a-client?view=sql-server-2017). Как только псевдоним добавлен и Configuration Manager может установить подключение к базе данных WSUS, будут добавлены индексы.

### <a name="remove-obsolete-updates-from-the-wsus-database"></a>Удаление устаревших обновлений из базы данных WSUS

Устаревшие обновления — это неиспользуемые обновления и редакции обновлений в базе данных WSUS. Как правило, обновление считается устаревшим, когда оно больше не находится в [каталоге центра обновления Майкрософт](https://www.catalog.update.microsoft.com/) и не требуется другим обновлениям в качестве необходимого компонента или зависимости.

1. В консоли Configuration Manager перейдите в раздел **Администрирование** > **Обзор** > **Конфигурация сайта** > **Сайты**.
2. Выберите сайт в верхней части иерархии Configuration Manager.
3. Щелкните **Настройка компонентов сайта** в группе "Параметры", а затем **Точка обновления программного обеспечения**, чтобы открыть свойства компонента точки обновления программного обеспечения.
4. На вкладке **Обслуживание WSUS** выберите команду **Удалить устаревшие обновления из базы данных WSUS**.
   - Удаление устаревших обновлений будет выполняться не более 30 минут до остановки. Оно запустится еще раз после следующей синхронизации.  

#### <a name="sql-permissions-for-removing-obsolete-updates"></a>Разрешения SQL для удаления устаревших обновлений

Если база данных WSUS размещается на удаленном экземпляре SQL Server, для учетной записи компьютера сервера сайта требуются следующие разрешения SQL:

- Предопределенные роли базы данных `db_datareader` и `db_datawriter`. См. подробнее о [ролях уровня базы данных](https://docs.microsoft.com/sql/relational-databases/security/authentication-access/database-level-roles?view=sql-server-2017#fixed-database-roles).
- Необходимо предоставить разрешение сервера `CONNECT SQL` для учетной записи компьютера сервера сайта. См. подробнее о [предоставлении разрешении сервера (Transact-SQL)](https://docs.microsoft.com/sql/t-sql/statements/grant-server-permissions-transact-sql?view=sql-server-2017).

#### <a name="wsus-cleanup-wizard"></a>Мастер очистки WSUS

Начиная с версии 1906, следующие параметры **мастера очистки сервера WSUS** недоступны на сайте центра администрирования, а также на основных и дополнительных сайтах:

- Компьютеры, не взаимодействующие с сервером
- Ненужные файлы обновлений

  Дополнительные сведения и инструкции см. в записи блога [The complete guide to Microsoft WSUS and Configuration Manager SUP maintenance](https://support.microsoft.com/help/4490644/complete-guide-to-microsoft-wsus-and-configuration-manager-sup-maint/) (Полное руководство по обслуживанию Microsoft WSUS и точек обновления ПО Configuration Manager).


### <a name="known-issues-for-version-1906"></a>Известные проблемы для версии 1906

Рассмотрим следующий сценарий.
<!--5418148-->
- Вы используете Configuration Manager версии 1906
- У вас есть удаленные точки обновления программного обеспечения, использующие внутреннюю базу данных Windows
- В **свойствах компонента точки обновления программного обеспечения** выбраны следующие параметры на вкладке **Обслуживание WSUS**:
   - Добавление некластеризованных индексов в базу данных WSUS
   - Удаление устаревших обновлений из базы данных WSUS

В этом сценарии Configuration Manager не может выполнить указанные выше задачи обслуживания WSUS для удаленных точек обновления программного обеспечения с помощью внутренней базы данных Windows. Эта проблема возникает из-за того, что во внутренней базе данных Windows не разрешены удаленные соединения. В `WSyncMgr.log` на сервере сайта будут отображаться следующие ошибки:

```text
Indexing Failed. Could not connect to SUSDB.
SqlException thrown while connect to SUSDB in Server: <SUP.CONTOSO.COM>. Error Message: A network-related or instance-specific error occurred while establishing a connection to SQL Server. The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is configured to allow remote connections. (provider: Named Pipes Provider, error: 40 - Could not open a connection to SQL Server)
...
Could not Delete Obselete Updates because ConfigManager could not connect to SUSDB: A network-related or instance-specific error occurred while establishing a connection to SQL Server. The server was not found or was not accessible. Verify that the instance name is correct and that SQL Server is configured to allow remote connections. (provider: Named Pipes Provider, error: 40 - Could not open a connection to SQL Server) UpdateServer: <SUP.CONTOSO.COM>
```

Чтобы обойти эту проблему, можно автоматизировать обслуживание WSUS для удаленных точек обновления программного обеспечения с помощью внутренней базы данных Windows. Дополнительные сведения и инструкции см. в [полном руководстве по обслуживанию Microsoft WSUS и точек обновления ПО Configuration Manager](https://support.microsoft.com/help/4490644/complete-guide-to-microsoft-wsus-and-configuration-manager-sup-maint).

## <a name="updates-cleanup-log-entries"></a>Записи в журнале об очистке обновлений

Проверить результат выполнения очистки обновлений можно, просмотрев следующие записи в файле wsyncmgr.log:

- Об отклонении заменяемых обновлений в WSUS свидетельствует эта запись в журнале: `Cleanup processed <number> total updates and declined <number>`
- О начале очистки WSUS свидетельствует эта запись в журнале: `Calling WSUS Cleanup.`
- О завершении очистки WSUS для просроченных обновлений свидетельствует эта запись в журнале: `Successfully completed WSUS Cleanup.`
- О начале отчистки Configuration Manager элементов конфигурации просроченных обновлений свидетельствует эта запись в журнале: `Deleting old expired updates...`
- О завершении отчистки Configuration Manager элементов конфигурации просроченных обновлений свидетельствует эта запись в журнале: `Deleted <number> expired updates total`
