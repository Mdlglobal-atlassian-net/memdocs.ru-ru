---
title: Необходимые условия для обновлений программного обеспечения
titleSuffix: Configuration Manager
description: Ознакомьтесь с необходимыми условиями для обновления программного обеспечения в Configuration Manager.
author: mestew
ms.author: mstewart
manager: dougeby
ms.date: 08/22/2019
ms.topic: conceptual
ms.prod: configuration-manager
ms.technology: configmgr-sum
ms.assetid: fdf05118-162a-411e-b72e-386b9dc9a5e1
ms.openlocfilehash: 138ff268f42dae1c15e11b34c92e6c7a3044705b
ms.sourcegitcommit: 1442a4717ca362d38101785851cd45b2687b64e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2020
ms.locfileid: "82078453"
---
# <a name="prerequisites-for-software-updates-in-configuration-manager"></a>Необходимые условия для обновления программного обеспечения в Configuration Manager

*Область применения: Configuration Manager (Current Branch)*

В этой статье перечислены необходимые условия для обновления программного обеспечения в Configuration Manager. Для каждого из этих необходимых условий внешние и внутренние зависимости перечислены в отдельных таблицах.  

## <a name="software-update-dependencies-that-are-external-to-configuration-manager"></a>Зависимости обновления программного обеспечения, являющиеся внешними для Configuration Manager  
 В следующих разделах перечислены внешние зависимости для обновления программного обеспечения.  

### <a name="internet-information-services"></a>Службы IIS  
 Службы IIS должны быть установлены на серверах системы сайта для запуска точки обновления программного обеспечения, точки управления и точки распространения. Дополнительные сведения см. в разделе [Необходимые компоненты для ролей системы сайта](../../core/plan-design/configs/site-and-site-system-prerequisites.md).  

### <a name="windows-server-update-services"></a>Службы WSUS  
 Службы обновления Windows Server (Windows Server Update Services, WSUS) необходимы для синхронизации обновлений программного обеспечения, а также для проверки применимости обновлений на клиентах. Сервер служб WSUS должен быть установлен перед созданием роли "Точка обновления программного обеспечения". Для точки обновления программного обеспечения поддерживаются следующие версии служб WSUS:  

- WSUS 10.0.14393 (роль в Windows Server 2016);
- WSUS 10.0.17763 (роль в Windows Server 2019) (требуется Configuration Manager 1810 или более поздней версии);
- WSUS 6.2 и 6.3 (роль в Windows Server 2012 и Windows Server 2012 R2);
  - При развертывании обновлений Windows 10 требуется [KB 3095113 и KB 3159706 (или эквивалентное обновление)](#BKMK_wsus2012) для WSUS 6.2 и 6.3.

> [!NOTE]
> - При наличии нескольких точек обновления программного обеспечения на сайте убедитесь в том, что они используют одинаковую версию WSUS.

### <a name="wsus-administration-console"></a>Консоль администрирования WSUS  
Консоль администрирования WSUS необходима на сервере сайта Configuration Manager, если точка обновления программного обеспечения находится на удаленном сервере системы сайта, а службы WSUS еще не установлены на сервере сайта.  

> [!IMPORTANT]  
> - Версия WSUS на сервере сайта должна совпадать с версией WSUS в точках обновления программного обеспечения.
> - Не пользуйтесь консолью администрирования WSUS для настройки параметров служб WSUS. Диспетчер Configuration Manager подключается к экземпляру служб WSUS в точке обновления ПО и настраивает соответствующие параметры.  


### <a name="windows-update-agent"></a>Агент обновления Windows  
 Агент Центра обновления Windows (WUA) требуется на клиентах, чтобы они могли подключаться к серверу WSUS. WUA получает список обновлений программного обеспечения, которые необходимо проверить на соответствие требованиям.  

 При установке Configuration Manager скачивается последняя версия WUA. Затем, когда устанавливается клиент Configuration Manager, при необходимости производится обновление WUA. Если выполнить установку не удастся, необходимо использовать другой метод обновления WUA.  

## <a name="software-update-dependencies-that-are-internal-to-configuration-manager"></a>Зависимости обновления программного обеспечения, являющиеся внутренними для Configuration Manager  
 В следующих разделах перечислены внутренние зависимости для обновлений программного обеспечения в Configuration Manager.  

### <a name="management-points"></a>Точки управления  
 Точки управления передают данные между клиентскими компьютерами и сайтом Configuration Manager. Они необходимы для обновления программного обеспечения.  

### <a name="software-update-points"></a>Точки обновления программного обеспечения  
 Необходимо установить точку обновления программного обеспечения на сервере WSUS для развертывания обновлений ПО в Configuration Manager. Дополнительные сведения см. в разделе [Установка и настройка точки обновления программного обеспечения](../get-started/install-a-software-update-point.md).

### <a name="distribution-points"></a>Точки распространения  
 Точки распространения должны хранить контент для обновлений программного обеспечения. Дополнительные сведения об установке точек распространения и управлении содержимым см. в разделе [Управление содержимым и инфраструктурой содержимого](../../core/servers/deploy/configure/manage-content-and-content-infrastructure.md).  

### <a name="client-settings-for-software-updates"></a>Параметры клиентов для обновлений программного обеспечения  
Обновления программного обеспечения включены для клиентов по умолчанию. Доступны и другие параметры, контролирующие, как и когда клиенты оцениваются на соответствие для обновлений ПО и как выполняется установка обновлений.  

 Дополнительные сведения см. в следующих статьях:  

- [Параметры клиентов для обновлений программного обеспечения](../get-started/manage-settings-for-software-updates.md#BKMK_ClientSettings)   

- [Параметры клиента для обновлений программного обеспечения](../../core/clients/deploy/about-client-settings.md#software-updates)  

### <a name="reporting-services-points"></a>Точки служб отчетов  
 Роль системы сайта точки служб отчетов может отображать отчеты об обновлении программного обеспечения. Эта роль является необязательной, но использовать ее рекомендуется. Дополнительные сведения о создании точки служб отчетов см. в разделе [Настройка отчетов](../../core/servers/manage/configuring-reporting.md).  

## <a name="which-updates-are-required-on-wsus-62-and-63"></a><a name="BKMK_wsus2012"></a> Какие обновления необходимы для WSUS 6.2 и 6.3?

Для синхронизации классификации **Обновления** в WSUS 6.2 и 6.3 требуется два обновления. Иногда может появиться сообщение об ошибке при загрузке или развертывании обновлений, если они были синхронизированы до установки KB3095113 и KB3159706. Сведения о возможных проблемах см. в следующем разделе.  

- Необходимо установить выпущенное в октябре 2015 г. исправление [KB 3095113](https://support.microsoft.com/kb/3095113) на точках обновления программного обеспечения и серверах сайтов, прежде чем синхронизировать классификацию **Обновления**.
  - Это обновление включает классификацию **Обновления**.
- Для обслуживания Windows 10 версии 1607 и более поздних версий необходимо установить и настроить [KB 3159706](https://support.microsoft.com/en-us/help/3159706). KB 3159706 выпущено в мае 2016 года.
  - Это обновление позволяет WSUS в собственном коде расшифровывать файлы, используемые для обновления Windows 10 версии 1607 и более поздних версий.

>[!IMPORTANT]
> KB 3095113 и KB 3159706 включены в **ежемесячный накопительный пакет обновлений для системы безопасности** начиная с июля 2017 года. Это означает, что в качестве установленных обновлений могут не отображаться KB 3095113 и KB 3159706, так как они могут быть установлены в рамках накопительного пакета обновлений. Однако если требуется одно из этих обновлений, рекомендуется установить **ежемесячный накопительный пакет обновлений для системы безопасности**, выпущенный после октября 2017 года, так как он содержит дополнительное обновление WSUS для уменьшения использования памяти в ClientWebService WSUS.

## <a name="download-of-windows-10-upgrades-fails-with-error-invalid-certificate-signature-or-0xc1800118"></a><a name="BKMK_RecoverUpgrades"></a> Скачивание обновлений Windows 10 завершается ошибкой "Недопустимая подпись сертификата" или 0xc1800118

Обновления и проблемы, описанные в этом разделе, применимы только к службам WSUS на компьютерах под управлением Windows Server 2012 или Windows Server 2012 R2 (WSUS 6.2 и 6.3). Как правило, проблемы, описанные в этом разделе, возникают только в том случае, если вы установили службы WSUS до июля 2017 года и недавно включили классификацию **Обновления**. Однако с этими проблемами можно столкнуться и в других ситуациях.

### <a name="historical-information-about-kb-3095113"></a>Исторические сведения о KB 3095113

 Версия [KB 3095113](https://support.microsoft.com/kb/3095113) была [выпущена в виде исправления](https://blogs.technet.microsoft.com/wsus/2015/12/03/important-update-for-wsus-4-0-kb-3095113/) в октябре 2015 года, чтобы добавить поддержку обновлений Windows 10 для WSUS. Это обновление позволяет WSUS синхронизировать и распространять обновления в классификации **Обновления** для Windows 10.

Если синхронизировать какие-либо обновления, не установив сначала [KB 3095113](https://support.microsoft.com/kb/3095113), вы заполните базу данных WSUS (SUSDB) непригодными для использования данными. Эти данные придется очистить, чтобы корректно развертывать обновления. Обновления Windows 10 в этом состоянии невозможно загрузить с помощью мастера загрузки обновлений программного обеспечения.

На странице "Завершение" мастера загрузки обновлений программного обеспечения отображаются ошибки, аналогичные приведенным ниже:

``` Output
Error: Upgrade to Windows 10 Pro, version 1511, 10586
Failed to download content id {content_id}. Error: Invalid certificate signature
```

Кроме того, эти ошибки регистрируются в файле PatchDownloader.log:

``` Log
Download http://wsus.ds.b1.download.windowsupdate.com/d/upgr/2015/12/10586.0.151029-1700.th2_release_...esd...
Authentication of file C:\Users\{username}\AppData\Local\Temp\2\{temporary_filename}.tmp failed, error 0x800b0004
ERROR: DownloadContentFiles() failed with hr=0x80073633
# This log is truncated for readability.
```

Раньше эти ошибки разрешались с помощью измененной версии [действий по разрешению для WSUS](https://blogs.technet.microsoft.com/wsus/2016/01/29/how-to-delete-upgrades-in-wsus/). Так как эти действия похожи на разрешение, чтобы не выполнять ручные действия, необходимые после установки KB 3159706, мы объединили оба набора шагов в одно разрешение в разделе ниже:

- [Восстановление после синхронизации обновлений до установки исправлений KB 3095113 или KB 3159706](#bkmk_fix-upgrades).

### <a name="historical-information-about-kb-3159706"></a>Исторические сведения о KB знаний 3159706

Версия KB 3148812 изначально была выпущена в апреле 2016 года, чтобы включить поддержку WSUS для собственной расшифровки ESD-файлов, используемых для обновления пакетов Windows 10. [Версия KB 3148812 приводила к проблемам для некоторых клиентов](https://blogs.technet.microsoft.com/wsus/2016/05/05/the-long-term-fix-for-kb3148812-issues/) и была заменена на [KB 3159706](https://support.microsoft.com/en-us/help/3159706). Прежде чем обслуживать устройства Windows 10 версии 1607 и более поздних, необходимо установить KB 3159706 на всех точках обновления программного обеспечения и серверах сайта. Тем не менее проблемы могут возникнуть, если вы не выполните следующие действия вручную после установки KB:

1. В командной строке с повышенными привилегиями выполните `"C:\Program Files\Update Services\Tools\wsusutil.exe" postinstall /servicing`.
1. Перезапустите службу WSUS на всех серверах WSUS.

Если вы не знаете, что для KB 3159706 нужно выполнить некоторые действия вручную после установки, или синхронизируете обновление для Windows 10 1607 перед установкой KB 3159706, вы столкнетесь с проблемами подключения к консоли WSUS и развертывания обновления соответственно. Когда клиент загружает файл обновления, он получает [код ошибки **0xC1800118**](https://support.microsoft.com/help/3194588/0xc1800118-error-when-you-push-windows-10-version-1607-by-using-wsus).

Так как действия по разрешению аналогичны разрешению для синхронизации обновлений до установки KB 3095113, мы объединили оба набора шагов в одно разрешение в следующем разделе.
 

### <a name="to-recover-from-synchronizing-the-upgrades-before-you-install-kb-3095113-or-kb-3159706"></a><a name="bkmk_fix-upgrades"></a> Восстановление после синхронизации обновлений до установки исправлений KB 3095113 или KB 3159706

Выполните следующие действия, чтобы разрешить ошибку 0xc1800118 и ошибку "Недопустимая подпись сертификата":

1. Отключите классификацию **Обновления** в службах WSUS и Configuration Manager. Синхронизация не должна происходить до тех пор, пока об этом не будет сказано в настоящих инструкциях.  
   - Снимите флажок классификации **Обновления** в свойствах компонента точки обновления программного обеспечения на сайте верхнего уровня.
     - Дополнительные сведения: [Настройка классификаций и продуктов](../get-started/configure-classifications-and-products.md).
   - Снимите флажок классификация **Обновления** в службах WSUS в разделе **Продукты и классификации** на [странице **Параметры**](https://docs.microsoft.com/windows-server/administration/windows-server-update-services/manage/setting-up-update-synchronizations) или воспользуйтесь интегрированной средой сценариев PowerShell с правами администратора.
      ```PowerShell
      Get-WsusClassification | Where-Object -FilterScript {$_.Classification.Title -Eq "Upgrades"} | Set-WsusClassification -Disable
      ```  
     - Если вы используете базу данных WSUS на нескольких серверах WSUS, необходимо снять флажок **Обновления** только однажды для каждой базы данных.  
1. На каждом сервере WSUS в командной строке с повышенными привилегиями выполните команду: `"C:\Program Files\Update Services\Tools\wsusutil.exe" postinstall /servicing`. Затем перезапустите службу WSUS на всех серверах WSUS.
   -  WSUS помещает базу данных в [однопользовательский режим](https://docs.microsoft.com/sql/relational-databases/databases/set-a-database-to-single-user-mode), прежде чем проверить, требуется ли обслуживание. Обслуживание запускается или не запускается на основе результатов проверки. Затем база данных переводится обратно в многопользовательский режим. 
   - Если вы используете базу данных WSUS на нескольких серверах WSUS, необходимо выполнить это обслуживание только однажды для каждой базы данных.
1. Удалите все обновления Windows 10 из каждой базы данных WSUS с помощью интегрированной среды сценариев PowerShell от имени администратора.
   ```PowerShell
   [reflection.assembly]::LoadWithPartialName("Microsoft.UpdateServices.Administration")
   $wsus = [Microsoft.UpdateServices.Administration.AdminProxy]::GetUpdateServer();
   $wsus.GetUpdates() | Where {$_.UpdateClassificationTitle -eq 'Upgrades' -and $_.Title -match 'Windows 10'} `
   | ForEach-Object {$wsus.DeleteUpdate($_.Id.UpdateId.ToString()); Write-Host $_.Title removed}
   ```
1. Удалите файлы из таблицы tbFile из каждой базы данных WSUS, используемой точками обновления программного обеспечения. В базе данных WSUS выполните следующие команды из SQL Server Management Studio:
   ```SQL
   declare @NotNeededFiles table (FileDigest binary(20) UNIQUE)
   insert into @NotNeededFiles(FileDigest) (select FileDigest from tbFile where FileName like '%.esd%'  except select FileDigest from tbFileForRevision)
   delete from tbFileOnServer where FileDigest in (select FileDigest from @NotNeededFiles)
   delete from tbFile where FileDigest in (select FileDigest from @NotNeededFiles)
   ```
1. Запустите синхронизацию обновлений программного обеспечения на сайте верхнего уровня в Configuration Manager и дождитесь ее завершения. Полная синхронизация происходит потому, что мы внесли изменения в классификации Configuration Manager, когда удалили **Обновления**. Дополнительные сведения: [Синхронизация обновлений программного обеспечения](../get-started/synchronize-software-updates.md).
1. Выберите классификацию **Обновления** в свойствах компонента точки обновления программного обеспечения. Затем запустите другую синхронизацию обновлений программного обеспечения, чтобы вернуть **Обновления** в WSUS и Configuration Manager. Вам не нужно включать классификацию **Обновления** в службах WSUS, так как Configuration Manager сделает это автоматически.
1. Если клиенты получают код ошибки **0xC1800118** при загрузке обновления, необходимо удалить хранилище данных, используемое агентом центра обновления Windows. Также может потребоваться удалить скрытую папку ~BT на устройстве. В следующий раз будет произведено полное сканирование клиента с использованием сервера WSUS, а не разности. Можно использовать скрипт PowerShell, аналогичный следующему примеру:  
   ```PowerShell
   stop-service wuauserv
   remove-item -path c:\windows\softwaredistribution\datastore -recurse -force
   # If the device has a hidden ~BT folder on the c drive, delete it too by uncommenting the next line.
   # remove-item -path c:\~BT -recurse -force
   start-service wuauserv
   ```

## <a name="next-steps"></a>Дальнейшие шаги
[Подготовка к управлению обновлением программного обеспечения](../get-started/prepare-for-software-updates-management.md)
