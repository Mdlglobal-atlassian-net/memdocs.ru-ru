---
title: Одноранговый кэш клиентов
titleSuffix: Configuration Manager
description: Используйте одноранговый кэш клиентов для исходных расположений при развертывании содержимого с помощью Configuration Manager.
ms.date: 09/19/2018
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: conceptual
ms.assetid: 86cd5382-8b41-45db-a4f0-16265ae22657
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: a1b9afc8c9cde94488908e4cd9737a58547326f9
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81703672"
---
# <a name="peer-cache-for-configuration-manager-clients"></a>Одноранговый кэш для клиентов Configuration Manager

*Область применения: Configuration Manager (Current Branch)*

<!--1101436-->
Одноранговый кэш клиентов помогает управлять развертыванием содержимого в клиентах в удаленных расположениях. Одноранговый кэш — это встроенное решение Configuration Manager, которое позволяет клиентам делиться содержимым с другими клиентами непосредственно из своего локального кэша.   

> [!Note]  
> По умолчанию в версии 1906 в Configuration Manager эта функция включена. В версии 1902 и более ранних по умолчанию в Configuration Manager эта дополнительная функция отключена. Перед использованием ее необходимо включить. Дополнительные сведения см. в разделе [Включение дополнительных функций из обновлений](../../servers/manage/install-in-console-updates.md#bkmk_options).<!--505213-->  



## <a name="overview"></a>Обзор

Определения:  

- **Клиент однорангового кэша**. Любой клиент Configuration Manager, который скачивает содержимое из однорангового узла.  

- **Источник однорангового кэша**. Клиент Configuration Manager, который можно включить для однорангового кэша и у которого есть содержимое для совместного использования с другими клиентами.  

С помощью параметров клиента настройте клиенты в качестве источников однорангового кэша. Включать клиенты однорангового кэша не требуется. Когда вы включаете клиенты в качестве источников однорангового кэша, точка управления добавляет их в список источников расположения содержимого.<!--510397--> Дополнительные сведения об этом процессе см. в разделе [Операции](#operations).  

Источник однорангового кэша должен быть членом текущей группы границ клиента однорангового кэша. Точка управления не включает источники однорангового кэша из соседней группы границ в список источников содержимого, который она предоставляет клиенту. Она включает только точки распространения из соседней группы границ. Дополнительные сведения о текущих и соседних группах границ см. в разделе [Группы границ](../../servers/deploy/configure/boundary-groups.md).<!--SCCMDocs issue 685-->  

Клиент Configuration Manager использует одноранговый кэша для предоставления каждого типа содержимого в кэше другим клиентам. В это содержимое входят файлы Office 365 и файлы экспресс-установки.<!--SMS.500850-->  

Одноранговый кэш не заменяет собой другие решения, такие как Windows BranchCache и оптимизация доставки. Одноранговый кэш работает параллельно с другими решениями. Эти технологии предоставляют дополнительные возможности помимо традиционных методов развертывания содержимого, таких как точки распространения. Это специализированное решение, которое не связано с BranchCache. Одноранговый кэш будет работать даже при отключенном BranchCache.  

> [!Note]  
> Начиная с версии 1802 кэш Windows BranchCache всегда включен в развертываниях. Параметр **Разрешить клиентам использовать содержимое совместно с другими клиентами из той же подсети** удален.<!--SCCMDocs issue 539--> Клиенты используют BranchCache, если точка распространения поддерживает эту технологию и если она включена в настройках клиента. Дополнительные сведения см. в разделе, посвященном [настройке BranchCache](../../clients/deploy/about-client-settings.md#configure-branchcache).<!--SCCMDocs issue 735-->   



## <a name="operations"></a>Операции

Чтобы включить одноранговый кэш, разверните [параметры клиента](#bkmk_settings) в коллекции. После этого члены данной коллекции выступают в качестве источника однорангового кэша для других клиентов в той же группе границ.  

- Клиент, который выступает в качестве источника однорангового содержимого, передает список доступного кэшированного содержимого в свою точку управления, используя сообщения о состоянии.

   > [!NOTE]
   > См. в разделе [Сообщения о состоянии в Configuration Manager](state-messaging-system-center-configuration-manager.md#7200-state_topictype_super_peer_update_cache_map) список соответствующих сообщений о состоянии источника однорангового содержимого, в частности с идентификаторами сообщений о состоянии 7200, 7201, 7202 и 7203.

- Другой клиент в той же группе границ запрашивает расположение содержимого в точке управления. Сервер возвращает список возможных источников содержимого. Этот список содержит каждый источник однорангового кэша, который имеет содержимое и находится в сети. В этот список также входят точки распространения и другие расположения источников содержимого в этой группе границ. Дополнительные сведения см. в разделе [Приоритет источника содержимого](fundamental-concepts-for-content-management.md#content-source-priority).  

- Как правило, клиент, ищущий содержимое, выбирает один источник содержимого в предоставленном списке. После этого он пытается получить содержимое.  

Начиная с версии 1806 группы границ включают дополнительные настройки для получения большего контроля над распространением содержимого в среде. Дополнительные сведения см. в разделе [Параметры группы границ для одноранговых скачиваний](../../servers/deploy/configure/boundary-groups.md#bkmk_bgoptions).<!--1356193-->

> [!NOTE]  
> Если клиент выполняет откат к соседней группе границ, точка управления не добавляет источники однорангового кэша из соседней группы границ в список потенциальных расположений источников содержимого.  

Выбирайте только те клиенты, которые лучше всего подходят в качестве источников однорангового кэша. Определить эти клиенты можно по таким характеристикам, как тип шасси, место на диске и сетевое подключение. Дополнительные сведения о выборе подходящих клиентов для однорангового кэша см. в [этом блоге консультанта Майкрософт](https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/configuration-manager-peer-cache-custom-reporting-examples/ba-p/570801).


### <a name="limited-access-to-a-peer-cache-source"></a>Ограниченный доступ к источнику однорангового кэша  

Источник однорангового кэша отклоняет запросы на получение содержимого, если для него выполняется любое из указанных ниже условий во время запроса содержимого одноранговым узлом.  

- Находится в режиме низкого заряда батареи.  

- Загрузка процессора превышает 80 %.  

- Значение параметра *AvgDiskQueueLength* дисковых операций ввода-вывода превышает 10.  

- Отсутствуют доступные подключения к компьютеру.  

> [!Tip]  
> Эти параметры можно настроить с помощью функции источника однорангового кэша (*SMS_WinPEPeerCacheConfig*) из класса WMI для сервера конфигурации клиента, используя пакет SDK для Configuration Manager.  

Когда источник однорангового кэша отклоняет запрос на содержимое, клиент однорангового кэша продолжает поиск содержимого по списку доступных источников.   



## <a name="requirements"></a>Requirements (Требования)

- Одноранговый кэш поддерживает все версии Windows, перечисленные в статье [Поддерживаемые операционные системы для клиентов и устройств](../configs/supported-operating-systems-for-clients-and-devices.md). Операционные системы, отличные от Windows, не поддерживаются в качестве источников однорангового кэша и клиентов однорангового кэша.  

- Источник однорангового кэша должен быть клиентом Configuration Manager, присоединенным к домену. Однако клиент, который не присоединен к домену, может получать содержимое из источника однорангового кэша, присоединенного к домену.  

- Клиенты могут загружать содержимое только из источников однорангового кэша, находящихся в одной с ними группе границ.  

- [Учетная запись сетевого доступа](accounts.md#network-access-account) нужна только в следующих ситуациях.  

  - Настройка учетной записи сетевого доступа на сайте, когда клиент, поддерживающий одноранговый кэш, запускает из центра программного обеспечения последовательность задач, которая выполняет перезагрузку с использованием образа загрузки. Когда устройство находится в среде Windows PE, оно использует эту учетную запись для получения содержимого из источника однорангового кэша.  

  - При необходимости источник однорангового кэша применяет учетную запись сетевого доступа для проверки подлинности запросов на загрузку от одноранговых узлов. Для этой цели такой учетной записи нужны лишь права пользователя домена.  

- Начиная с версии 1802 и более ранней отправка последнего Heartbeat-обнаружения клиента определяет текущую границу источника однорангового кэша. Клиент, который перемещается в другую группу границ, может оставаться членом прежней группы с точки зрения использования однорангового кэша. Это приводит к тому, что клиенту предлагается источник однорангового кэша, находящийся в другом сетевом расположении. Не включайте перемещаемые клиенты в качестве источника однорангового кэша.<!--SCCMDocs issue 641-->  

  > [!Important]  
  > Начиная с версии 1806 Configuration Manager позволяет более эффективно определять, перемещен ли источник однорангового кэша в другое расположение. Такое поведение гарантирует, что точка управления предлагает его в качестве источника содержимого клиентам в новом, а не старом расположении. Если вы используете функцию однорангового кэша с перемещаемыми источниками однорангового кэша, после обновления сайта до версии 1806 также следует обновить все источники однорангового кэша до последней версии клиента. Точка управления не включает эти источники однорангового кэша в список расположений содержимого, пока они не будут обновлены хотя бы до версии 1806.<!--SCCMDocs issue 850-->  

- Прежде чем пытаться скачать содержимое, точка управления сначала проверяет, подключен ли источник однорангового кэша к сети.<!--sms.498675--> Эта проверка осуществляется для уведомления клиента через быстрый канал, который использует TCP-порт 10123.<!--511673-->  

> [!Note]  
> Чтобы воспользоваться преимуществами новых функций Configuration Manager, сначала необходимо обновить клиенты до последней версии. Хотя новые функции появляются в консоли Configuration Manager после обновления ее и сайта, полный сценарий будет работать только с последней версией клиента.  



## <a name="peer-cache-client-settings"></a><a name="bkmk_settings"></a> Параметры клиента однорангового кэша

Дополнительные сведения о параметрах клиента однорангового кэша см. в статье [Параметры кэша клиента](../../clients/deploy/about-client-settings.md#client-cache-settings). 

Дополнительные сведения о настройке этих параметров см. в разделе [Настройка параметров клиента](../../clients/deploy/configure-client-settings.md).

В клиентах с включенным одноранговым кэшем, использующих брандмауэр Windows, Configuration Manager настраивает порты брандмауэра, указанные в параметрах клиента.



## <a name="partial-download-support"></a><a name="bkmk_parts"></a> Поддержка частичного скачивания
<!--1357346-->
Начиная с версии 1806 источники однорангового кэша клиента поддерживают разделение содержимого на части. Применение таких частей позволяет свести к минимуму объем передаваемых по сети данных и снизить нагрузку на глобальную сеть. Точка управления предоставляет возможности детального отслеживания частей содержимого. Такой подход позволяет в некоторых случаях исключить многократное скачивание одного и того же содержимого в рамках одной группы границ. 


### <a name="example-scenario"></a>Пример сценария

В компании Contoso используется один основной сайт с двумя группами границ: головной офис и филиал. Между двумя группами границ устанавливается 30-минутное резервное отношение. Точка управления и точка распространения для сайта присутствуют только в границах головного офиса. Для филиала локальная точка распространения отсутствует. Два из четырех клиентов в филиале настроены как источники однорангового кэша. 

![Схема конфигурации сети, соответствующая описанию в примере сценария](media/1357346-peer-cache-source-parts.png)

1. Вы настраиваете целевое развертывание с содержимым для всех четырех клиентов в филиале. Распространение содержимого осуществляется только в точку распространения.  

2. У клиентов 3 и 4 нет локального источника развертывания. Точка управления устанавливает для клиентов 30-минутный период ожидания, прежде чем выполнить откат к удаленной группе границ.  

3. Клиент 1 (PCS1) первым из источников однорангового кэша обновит политику с помощью точки управления. Поскольку этот клиент настроен в качестве источника однорангового кэша, точка управления инструктирует немедленно начать скачивание части A из точки распространения.  

4. Когда клиент 2 (PCS2) подключается к точке управления, скачивание части A уже идет, но еще не завершено, в связи с чем точка управления инструктирует немедленно начать скачивание части B из точки распространения.  

5. После завершения скачивания части A клиент PCS1 немедленно уведомляет об этом точку управления. Поскольку скачивание части B уже идет, но еще не завершено, точка управления инструктирует немедленно начать скачивание части C из точки распространения.  

6. После завершения скачивания части B клиент PCS2 немедленно уведомляет об этом точку управления. Точка управления инструктирует начать скачивание части D из точки распространения.  

7. После завершения скачивания части C клиент PCS1 немедленно уведомляет об этом точку управления. Точка управления информирует этот клиент о том, что в удаленной точке распространения больше нет частей для скачивания. Точка управления инструктирует этот клиент скачать часть B из локального однорангового узла PCS2.  

8. Этот процесс продолжается до тех пор, пока в обоих источниках однорангового кэша клиента не будут содержаться все полученные друг от друга части. Точка управления назначает приоритеты частям из удаленной точки распространения, прежде чем направить источникам однорангового кэша инструкции по скачиванию частей из локальных одноранговых узлов.  

9. Клиент 3 первым обновляет политику после истечения 30-минутного периода отката. На этом этапе он связывается с точкой управления, которая информирует его о новых локальных источниках. Вместо скачивания всего содержимого из точки распространения по глобальной сети этот клиент будет скачивать содержимое полностью из одного из источников однорангового кэша клиентов. Клиенты устанавливают приоритеты локальных одноранговых источников. 

> [!Note]  
> Если число источников однорангового кэша клиента превышает число частей содержимого, точка управления направляет остальным источникам инструкции ожидать отката, как это делают обычные клиенты. 


### <a name="configure-partial-download"></a>Настройка частичной загрузки

1. Настройте [группы границ](../../servers/deploy/configure/boundary-groups.md) и источники однорангового кэша, как обычно.  

2. В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Конфигурация сайта** и выберите **Сайты**. Выберите **Параметры иерархии** на ленте.  

3. На вкладке **Общие** включите параметр для **настройки источников однорангового кэша клиента для разделения содержимого на части**.  

4. Создайте обязательное развертывание с содержимым.  

   > [!Note]  
   > Эта функция работает только при фоновом скачивании содержимого клиентом, как в случае с обязательным развертыванием. Скачивание по запросу, например если пользователь устанавливает доступное развертывание в центре программного обеспечения, выполняется в обычном режиме.  

Журналы скачивания содержимого по частям можно просмотреть в файлах **ContentTransferManager.log** в источнике однорангового кэша клиента и **MP_Location.log** в точке управления.  



## <a name="guidance-for-cache-management"></a>Рекомендации по управлению кэшем
<!--510645-->
Для совместного использования содержимого одноранговый кэш применяет кэш клиента Configuration Manager. Для управления кэшем клиента в существующей среде необходимо учитывать следующие моменты.  

- Кэш клиента Configuration Manager не похож на библиотеку содержимого в точке распространения. Если вы управляете содержимым, распространяемым в точку распространения, клиент Configuration Manager автоматически управляет содержимым в своем кэше. Существует ряд параметров и методов, позволяющих контролировать содержимое, находящееся в кэше источника однорангового кэша. Дополнительные сведения см. в статье [Настройка кэша клиента для клиентов Configuration Manager](../../clients/manage/manage-clients.md#BKMK_ClientCache).  

- Источники однорангового кэша поддерживают обычный размер кэша и возможности обслуживания. Дополнительные сведения см. в разделе [Настройка размера кэша клиента](../../clients/deploy/about-client-settings.md#configure-client-cache-size). Следует учитывать размер большого объема содержимого, например пакетов обновления операционной системы или файлов экспресс-обновления Windows 10. Сравните потребности в этом содержимом и размер свободного места на диске в источниках однорангового кэша.  

- Клиент источника однорангового кэша обновляет время последнего упоминания содержимого в кэше, когда одноранговый узел загружает это содержимое. Клиент использует эту метку времени при автоматическом обслуживании своего кэша, сначала удаляя устаревшее содержимое. Поэтому он должен ждать, чтобы удалить содержимое, чаще всего загружаемое клиентами однорангового кэша.  

- При необходимости во время последовательности задач развертывания операционной системы используйте переменную **SMSTSPreserveContent** для хранения содержимого в кэше клиента. Дополнительные сведения см. в описании [переменных последовательности задач](../../../osd/understand/task-sequence-variables.md#SMSTSPreserveContent).  

- Если необходимо, при создании следующего программного обеспечения используйте параметр **Persist content in the client cache** (Хранить содержимое в кэше клиента):  
  - Приложения
  - пакеты,
  - Образы ОС
  - Пакеты обновления ОС
  - загрузочные образы,



## <a name="monitoring"></a>Мониторинг   

Чтобы лучше понять использование однорангового кэша, просмотрите панель мониторинга **Источники данных клиента**. Дополнительные сведения см. в разделе [Панель мониторинга "Клиентские источники данных"](../../servers/deploy/configure/monitor-content-you-have-distributed.md#client-data-sources-dashboard).

Для изучения использования однорангового кэша хорошо подойдут отчеты. В консоли перейдите к рабочей области **Наблюдение**, разверните пункт **Отчеты** и выберите узел **Отчеты**. Следующие отчеты имеют тип **Содержимое для распространения ПО**.  

1.  **Отклонение содержимого источником однорангового кэша**. Этот отчет позволяет понять, как часто источники однорангового кэша, включенные в группу границ, отклоняют запрос на содержимое.  

    > [!Note]  
    > **Известная проблема**<!--486652-->: При детализации результатов, например по параметрам *MaxCPULoad* или *MaxDiskIO*, может появляться сообщение о невозможности найти отчет или подробные сведения. Чтобы устранить эту проблему, используйте два других отчета, отображающих результаты напрямую.  

2. **Отклонение содержимого источником однорангового кэша с разбивкой по условиям**. Отображает подробные сведения об отклонении для указанной группы границ или типа отклонения. 

    > [!Note]  
    > **Известная проблема**<!--486652-->: Невозможно выбрать доступные параметры — их нужно вводить вручную. Введите значения для *имени группы границ* и *типа отклонения*, как показано в отчете **Отклонение содержимого источником однорангового кэша**. Например, для *типа отклонения* можно ввести *MaxCPULoad* или *MaxDiskIO*.  

3. **Подробные сведения об отклонении содержимого источником однорангового кэша**. Отображает содержимое, которое клиент запрашивал при отклонении.  

    > [!Note]  
    > **Известная проблема**<!--486652-->: Невозможно выбрать доступные параметры — их нужно вводить вручную. Введите значение для *Rejection Type* (Тип отклонения), как указано в отчете **Отклонение содержимого источником однорангового кэша**. После этого введите *Идентификатор ресурса* для источника содержимого, о котором вы хотите получить дополнительные сведения. 
    > 
    > Чтобы найти идентификатор ресурса для источника содержимого, выполните следующие действия.  
    > 
    > 1. Найдите имя компьютера, которое отображается как *Источник однорангового кэша* в результатах отчета **Отклонение содержимого источником однорангового кэша по условию**.  
    > 
    > 2. Перейдите к рабочей области **Активы и соответствие**, выберите узел **Устройства** и выполните поиск имени этого компьютера. Используйте значение из столбца идентификатора ресурса.  

