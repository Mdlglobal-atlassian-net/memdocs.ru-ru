---
title: Сертификаты для шлюза управления облачными клиентами
titleSuffix: Configuration Manager
description: Сведения о различных цифровых сертификатах, используемых со шлюзом управления облачными клиентами.
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.date: 04/15/2020
ms.topic: conceptual
ms.prod: configuration-manager
ms.technology: configmgr-client
ms.assetid: 71eaa409-b955-45d6-8309-26bf3b3b0911
ms.openlocfilehash: 33e4ecbac965206ec4043f5adf91d2dbfb9602d8
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81694942"
---
# <a name="certificates-for-the-cloud-management-gateway"></a>Сертификаты для шлюза управления облачными клиентами

*Область применения: Configuration Manager (Current Branch)*

В зависимости от сценария, используемого для управления клиентами в Интернете с помощью шлюза управления облачными клиентами (CMG), требуется один или несколько следующих цифровых сертификатов:  

- [Сертификат проверки подлинности сервера шлюза CMG](#bkmk_serverauth).  
  - [Доверенный корневой сертификат шлюза CMG для клиентов](#bkmk_cmgroot).  
  - [Сертификат проверки подлинности сервера, выданный общедоступным поставщиком](#bkmk_serverauthpublic).  
  - [Сертификат проверки подлинности сервера, выданный PKI предприятия](#bkmk_serverauthpki).  

- [Сертификат проверки подлинности клиента](#bkmk_clientauth).  
  - [Доверенный корневой сертификат клиента для шлюза управления облачными клиентами](#bkmk_clientroot).  

- [Включение точки управления для использования протокола HTTPS](#bkmk_mphttps).  

- [Сертификат управления Azure](#bkmk_azuremgmt).  

Дополнительные сведения о сценариях см. в статье [Планирование работы шлюза управления облачными клиентами](plan-cloud-management-gateway.md).

## <a name="general-information"></a>Общие сведения

<!--SCCMDocs issue #779-->
Сертификаты для шлюза управления облачными клиентами поддерживают следующие конфигурации:  

- Длина ключа — 2048 или 4096 бит.

- Поставщики хранилища ключей для закрытых ключей сертификатов. Дополнительные сведения см. в статье [Общие сведения о сертификатах CNG](../../../plan-design/network/cng-certificates-overview.md).  

- При настройке Windows со следующей политикой: **Системная криптография: используйте FIPS-совместимые алгоритмы для шифрования, хэширования и подписывания**.  

- **TLS 1.2**. Дополнительные сведения см. в статье [Как включить TLS 1.2](../../../plan-design/security/enable-tls-1-2.md).  

## <a name="cmg-server-authentication-certificate"></a><a name="bkmk_serverauth"></a> Сертификат проверки подлинности сервера шлюза CMG

*Этот сертификат является обязательным во всех сценариях.*

Этот сертификат предоставляется при создании шлюза CMG в консоли Configuration Manager.

Шлюз CMG создает службу HTTPS, к которой будут подключаться интернет-клиенты. Для формирования безопасного канала серверу требуется сертификат проверки подлинности. Приобретите сертификат у общедоступного поставщика или получите его из своей инфраструктуры открытых ключей (PKI). Дополнительные сведения см. в разделе [Доверенный корневой сертификат шлюза CMG для клиентов](#bkmk_cmgroot).

> [!NOTE]
> Сертификат проверки подлинности сервера шлюза CMG поддерживает подстановочные знаки. Некоторые центры сертификации выдают сертификаты, используя подстановочный знак в качестве имени узла. Например, `*.contoso.com`. Некоторые организации применяют сертификаты с подстановочными знаками для упрощения инфраструктуры PKI и сокращения расходов на обслуживание.<!--491233-->  
>
> Дополнительные сведения об использовании сертификата с подстановочными знаками с CMG см. в разделе [Настройка шлюза управления облачными клиентами](setup-cloud-management-gateway.md#set-up-a-cmg).<!--SCCMDocs issue #565-->  

Для определения службы в Azure этому сертификату необходимо глобальное уникальное имя. Прежде чем запросить сертификат, убедитесь, что для домена Azure используется уникальное имя. Например, *GraniteFalls.CloudApp.Net*.

1. Войдите на [портал Azure](https://portal.azure.com).
1. Щелкните **Все ресурсы**, а затем нажмите кнопку **Добавить**.
1. Выполните поиск по запросу **Облачная служба**. Щелкните **Создать**.
1. В поле **DNS-имя** введите нужный префикс, например *GraniteFalls*. В интерфейсе будет указано, доступен ли домен или он уже используется другой службой.

    > [!Important]  
    > Не создавайте службу на портале. Просто воспользуйтесь этим процессом для проверки доступности имени.

Если вы включите CMG для содержимого, убедитесь, что имя службы CMG также является уникальным именем учетной записи хранения Azure. Если имя облачной службы CMG является уникальным, а имя учетной записи хранения — нет, Configuration Manager не сможет подготовить службу в Azure. Повторите описанную выше процедуру на портале Azure со следующими изменениями:

- Выполните поиск по запросу **Учетная запись хранения**.
- Проверьте имя в поле **Имя учетной записи хранения**.

Префикс DNS-имени, например *GraniteFalls*, должен иметь длину от 3 до 24 символов и состоять только из буквенно-цифровых символов. Не используйте специальные символы, такие как тире (`-`).<!-- SCCMDocs#1080 -->

### <a name="cmg-trusted-root-certificate-to-clients"></a><a name="bkmk_cmgroot"></a> Доверенный корневой сертификат шлюза CMG для клиентов

Между клиентами и сертификатом проверки подлинности сервера шлюза CMG должно существовать отношение доверия. Создать доверие можно двумя способами.

- Использовать сертификат от общедоступного и доверенного в глобальном масштабе поставщика сертификатов. Такими поставщиками могут быть, помимо прочего, DigiCert, Thawte или VeriSign. Клиенты Windows включают доверенные корневые центры сертификации (ЦС) от этих поставщиков. Используя сертификат проверки подлинности сервера, выданный одним из этих поставщиков, клиенты автоматически устанавливают с ним отношение доверия.  

- Использовать сертификат, выданный центром сертификации предприятия из инфраструктуры открытых ключей (PKI). Большинство реализаций PKI предприятия добавляют доверенные корневые ЦС в клиенты Windows. Например, использование служб сертификатов Active Directory с групповой политикой. Если сертификат проверки подлинности сервера шлюза управления облачными клиентами выдается из ЦС, с которым у ваших клиентов нет автоматического отношения доверия, добавьте доверенный корневой сертификат ЦС для интернет-клиентов.  

  - Для подготовки сертификатов на клиентах также можно использовать профили сертификатов Configuration Manager. Дополнительные сведения см. в статье [Общие сведения о профилях сертификатов](../../../../protect/deploy-use/introduction-to-certificate-profiles.md).

  - Если вы планируете [установить клиент Configuration Manager из Intune](../../../../comanage/how-to-prepare-Win10.md#install-the-configuration-manager-client), вы также можете использовать профили сертификатов Intune для подготовки сертификатов на клиентах. Дополнительные сведения: [Настройка профиля сертификата](https://docs.microsoft.com/intune/certificates-configure).

### <a name="server-authentication-certificate-issued-by-public-provider"></a><a name="bkmk_serverauthpublic"></a> Сертификат проверки подлинности сервера, выданный общедоступным поставщиком

Сторонний поставщик сертификатов не может создать сертификат для CloudApp.net, так как этот домен принадлежит корпорации Майкрософт. Вы можете получить сертификат, выданный только для принадлежащего вам домена. Основной причиной получения сертификата стороннего поставщика является то, что ваши клиенты уже доверяют корневому сертификату этого поставщика.

Воспользуйтесь следующей процедурой для создания DNS-псевдонима.

1. Создайте запись канонического имени (CNAME) на общем DNS-сервере организации. Эта запись формирует псевдоним для шлюза CMG в виде понятного имени, используемого в открытом сертификате.

    Например, компания Contoso называет свои CMG **GraniteFalls**. В Azure это имя становится **GraniteFalls.CloudApp.Net**. В пространстве имен contoso.com общедоступного DNS-сервера Contoso администратор DNS создает запись CNAME для **GraniteFalls.Contoso.com** для имени настоящего узла, **GraniteFalls.CloudApp.net**.  

2. Запросите сертификат проверки подлинности сервера у общедоступного поставщика, используя общее имя псевдонима CNAME.
Например, в качестве общего имени сертификата Contoso использует **GraniteFalls.Contoso.com**.  

3. С помощью этого сертификата создайте шлюз CMG в консоли Configuration Manager. На странице **Параметры** мастера создания шлюза управления облачными клиентами выполняются следующие действия.  

    - При добавлении сертификата сервера для этой облачной службы (из **файла сертификата**) мастер извлекает имя узла из общего имени сертификата в качестве имени службы.  

    - Затем, чтобы создать службу в Azure, он добавляет это имя узла в качестве полного доменного имени службы к **cloudapp.net** или **usgovcloudapp.net** для облака для государственных организаций США.  

    - Например, когда Contoso создает шлюз CMG, Configuration Manager извлекает имя узла **GraniteFalls** из общего имени сертификата. Azure создает фактическую службу с именем **GraniteFalls.CloudApp.net**.  

После создания экземпляра шлюза управления облачными системами в Configuration Manager, несмотря на то, что у сертификата указано GraniteFalls.Contoso.com, Configuration Manager извлекает только имя узла, например: GraniteFalls. Configuration Manager добавляет это имя узла к CloudApp.net, требуемому в Azure при создании облачной службы. Псевдоним CNAME в пространстве имен DNS для домена Contoso.com сопоставляет эти два полных доменных имени. Configuration Manager предоставляет клиентам политику для доступа к CMG, а сопоставление DNS выполняет объединение таким образом, чтобы можно было безопасно обращаться к службе в Azure.<!--SCCMDocs issue #565-->  

### <a name="server-authentication-certificate-issued-from-enterprise-pki"></a><a name="bkmk_serverauthpki"></a> Сертификат проверки подлинности сервера, выданный PKI предприятия

Создайте пользовательский SSL-сертификат для шлюза CMG так же, как и для облачной точки распространения. Следуйте инструкциям по [развертыванию сертификата службы для облачных точек распространения](../../../plan-design/network/example-deployment-of-pki-certificates.md#BKMK_clouddp2008_cm2012), за исключением следующих действий.

- При запросе пользовательского сертификата веб-сервера укажите полное доменное имя для общего имени сертификата. Это может быть имя общедоступного домена, которое принадлежит вам. Также можно использовать домен cloudapp.net. Если используется общедоступный домен, выше объясняется, как создать DNS-псевдоним в общедоступной службе DNS вашей организации.  

- При использовании общедоступного домена cloudapp.net для сертификата веб-сервера шлюза CMG выполните следующие действия.  

  - В общедоступном облаке Azure используйте имя, которое заканчивается на **cloudapp.net**  

  - Для облака Azure для государственных организаций США используйте имя, которое заканчивается на **usgovcloudapp.net**.  

## <a name="client-authentication-certificate"></a><a name="bkmk_clientauth"></a> Сертификат проверки подлинности клиента

*Этот сертификат необходим для интернет-клиентов, работающих под управлением Windows 8.1, а также для устройств Windows 10, не присоединенных к Azure Active Directory (Azure AD). Он также используется в точке подключения шлюза управления облачными клиентами. Он не требуется для клиентов Windows 10, присоединенных к Azure AD.*

Клиенты используют этот сертификат для прохождения проверки подлинности в шлюзе управления облачными клиентами. Этот сертификат не требуется для устройств Windows 10 с гибридным или облачным присоединением к домену, так как они выполняют проверку подлинности с помощью Azure AD.

Подготовка этого сертификата осуществляется вне контекста Configuration Manager. Например, для выдачи сертификатов проверки подлинности клиентов можно использовать службы сертификатов Active Directory и групповую политику. Дополнительные сведения см. в разделе [Развертывание сертификата клиента для компьютеров Windows](../../../plan-design/network/example-deployment-of-pki-certificates.md#BKMK_client2008_cm2012).

Для безопасной пересылки клиентских запросов точке подключения CMG требуется сертификат проверки подлинности клиента, соответствующий сертификату проверки подлинности сервера в точке управления HTTPS. Если клиенты используют проверку подлинности Azure AD или вы настраиваете точку управления для улучшенного протокола HTTP, этот сертификат не требуется. Дополнительные сведения см. в статье [Включение точки управления для HTTPS](#bkmk_mphttps).

> [!NOTE]
> Корпорация Майкрософт рекомендует присоединить устройства к Azure AD. Интернет-устройства могут использовать Azure AD для проверки подлинности в Configuration Manager. Кроме того, это позволяет выполнять сценарии как с устройствами, так и с пользователями, когда устройство подключено к Интернету или внутренней сети. Дополнительные сведения см. в разделе [Установка и регистрация клиента с помощью удостоверений Azure AD](../../deploy/deploy-clients-cmg-azure.md#install-and-register-the-client-using-azure-ad-identity).
>
> Начиная с версии 2002,<!--5686290--> Configuration Manager также предоставляет поддержку для интернет-клиентов, которые не так часто подключаются к внутренней сети, не могут присоединяться к Azure Active Directory (Azure AD) и для которых не предусмотрен метод установки сертификата, выданного PKI. Дополнительные сведения см. в разделе [Маркеры проверки подлинности в шлюзе управления облачными клиентами](../../deploy/deploy-clients-cmg-token.md).

### <a name="client-trusted-root-certificate-to-cmg"></a><a name="bkmk_clientroot"></a> Доверенный корневой сертификат клиента для шлюза управления облачными клиентами

*Этот сертификат обязателен при использовании сертификатов проверки подлинности клиента. Он не требуется, если все клиенты используют Azure AD для проверки подлинности.*

Этот сертификат предоставляется при создании шлюза CMG в консоли Configuration Manager.

Между шлюзом управления облачными клиентами и сертификатами проверки подлинности клиентов должно существовать отношение доверия. Чтобы установить отношение доверия, предоставьте цепочку доверенных корневых сертификатов. Обязательно добавьте все сертификаты в цепь доверия. Например, если сертификат проверки подлинности клиента выдается промежуточным центром сертификации, добавьте оба сертификата (промежуточного и корневого центра сертификации).

> [!Note]  
> При создании шлюза управления облачными клиентами больше не нужно указывать доверенный корневой сертификат на странице "Параметры". Этот сертификат не требуется при использовании Azure Active Directory (Azure AD) для проверки подлинности клиента, хотя он требовался в мастере. Если вы используете сертификаты проверки подлинности клиента на основе PKI, то вам по-прежнему необходимо добавить доверенный корневой сертификат в шлюз управления облачными клиентами.<!--SCCMDocs-pr issue #2872 SCCMDocs issue #1319-->
>
> В версии 1902 и более ранних версиях можно добавить только два доверенных корневых центра сертификации и четыре промежуточных (подчиненных) центра сертификации.

#### <a name="export-the-client-certificates-trusted-root"></a>Экспорт доверенного корня сертификата клиента

После выдачи сертификата проверки подлинности клиента для компьютера выполните на этом компьютере процедуру экспорта доверенного корня.

1. Откройте меню "Пуск". Введите "выполнить", чтобы открыть окно "Выполнить". Откройте `mmc`.  

2. В меню "Файл" выберите **Добавить или удалить оснастку**.  

3. В диалоговом окне "Добавление или удаление оснастки" выберите **Сертификаты** и нажмите кнопку **Добавить**.  

    1. В диалоговом окне оснастки сертификатов выберите **Учетная запись компьютера**, а затем нажмите кнопку **Далее**.  

    1. В диалоговом окне "Выбор компьютера" щелкните **Локальный компьютер**, а затем нажмите кнопку **Готово**.  

    1. В диалоговом окне "Добавление или удаление оснасток" нажмите кнопку **ОК**.  

4. Разверните узлы **Сертификаты**, **Личный** и выберите **Сертификаты**.  

5. Выберите сертификат с назначением **Проверка подлинности клиента**.  

    1. В меню "Действие" выберите **Открыть**.  

    1. Перейдите на вкладку **Путь сертификации**.  

    1. Выберите следующий сертификат в цепочке и щелкните **Просмотр сертификата**.  

6. В новом диалоговом окне "Сертификат" откройте вкладку **Сведения**. Щелкните **Копировать в файл**.  

7. Выполните остальные процедуры мастера экспорта сертификатов, используя формат сертификата по умолчанию, — **двоичные файлы X.509 (CER) в кодировке DER**. Запишите имя и расположение экспортированного сертификата.  

8. Экспортируйте все сертификаты по пути сертификации исходного сертификата проверки подлинности клиента. Запомните, какие экспортированные сертификаты являются промежуточными ЦС, а какие — доверенными корневыми ЦС.  

## <a name="enable-management-point-for-https"></a><a name="bkmk_mphttps"></a> Включение точки управления для использования протокола HTTPS

Подготовка этого сертификата осуществляется вне контекста Configuration Manager. Например, для выдачи сертификата веб-сервера можно использовать службы сертификатов Active Directory и групповую политику. Дополнительные сведения см. в статье [Требования к PKI-сертификатам](../../../plan-design/network/pki-certificate-requirements.md) и разделе [Развертывание сертификата веб-сервера для систем сайтов с запущенными службами IIS](../../../plan-design/network/example-deployment-of-pki-certificates.md#BKMK_webserver2008_cm2012).

При использовании параметра сайта **Использовать сертификаты, созданные с помощью Configuration Manager, для систем сайтов HTTP** точкой управления может быть HTTP. Подробнее см. в разделе [Улучшенный протокол HTTP](../../../plan-design/hierarchy/enhanced-http.md).

> [!Tip]  
> Если вы не используете улучшенный протокол HTTP и в вашей среде присутствует несколько точек управления, вам не нужно включать для этих точек протокол HTTPS для CMG. Установите для точек управления с поддержкой CMG значение **Только для Интернета**. Тогда ваши локальные клиенты не будут их использовать.<!-- SCCMDocs#1676 -->

### <a name="enhanced-http-certificate-for-management-points"></a>Улучшенный сертификат HTTP для точек управления

При включении улучшенного протокола HTTP сервер сайта создает самозаверяющий сертификат с именем **SSL-сертификат роли SMS**, выдаваемый корневым сертификатом выдачи SMS. Точка управления добавляет этот сертификат на веб-сайт IIS по умолчанию, привязанный к порту 443.

### <a name="management-point-client-connection-mode-summary"></a>Общие сведения о режиме подключения клиента к точке управления

В этой таблице указано, какой протокол (HTTP или HTTPS) требуется для точки управления в зависимости от типа клиента и версии сайта.

#### <a name="for-internet-based-clients-communicating-with-the-cloud-management-gateway"></a>Для клиентов в Интернете, взаимодействующих со шлюзом управления облачными клиентами

Настройте локальные точки управления, чтобы разрешить подключения из шлюза управления облачными клиентами со следующими режимами подключения клиентов:

| Тип клиента   | Точка управления |
|------------------|------------------|
| Рабочая группа        | E-HTTP<sup>[Примечание 1](#bkmk_note1)</sup>, HTTPS |
| Присоединенный к домену AD | E-HTTP<sup>[Примечание 1](#bkmk_note1)</sup>, HTTPS |
| Присоединенный к Azure AD  | E-HTTP, HTTPS |
| Гибридное присоединение    | E-HTTP, HTTPS |

<a name="bkmk_note1"></a>

> [!Note]  
> **Примечание 1**. Эта конфигурация требует, чтобы у клиента был [сертификат проверки подлинности клиента](#bkmk_clientauth), и поддерживает только сценарии, ориентированные на устройство.  

#### <a name="for-on-premises-clients-communicating-with-the-on-premises-management-point"></a>Для локальных клиентов, взаимодействующих с локальной точкой управления

Настройте локальные точки управления со следующими режимами подключения клиентов:

| Тип клиента   | Точка управления |
|------------------|------------------|
| Рабочая группа        | HTTP, HTTPS |
| Присоединенный к домену AD | HTTP, HTTPS |
| Присоединенный к Azure AD  | HTTPS       |
| Гибридное присоединение    | HTTP, HTTPS |

> [!NOTE]  
> Клиенты, присоединенные к домену AD, поддерживают сценарии, в которых устройства или пользователи взаимодействуют с точкой управления HTTP или HTTPS.  
>
> Клиенты, присоединенные к Azure AD, и клиенты с гибридным присоединением могут обмениваться данными по протоколу HTTP в сценариях, ориентированных на устройства, но требуют протокола E-HTTP или HTTPS в сценариях, ориентированных на пользователей. В остальном они работают так же, как клиенты рабочей группы.  

#### <a name="legend-of-terms"></a>Словарь терминов

- *Рабочая группа*. Устройство не присоединено к домену или Azure AD, но имеет [сертификат проверки подлинности клиента](#bkmk_clientauth).  
- *Присоединено к домену AD*. Устройство присоединено к локальному домену Active Directory.  
- *Присоединено к Azure AD*. Известно также как "Присоединено к облачному домену", устройство привязано к клиенту Azure Active Directory.  
- *Гибридное присоединение*. Устройство присоединено к домену Active Directory и клиенту Azure AD.  
- *HTTP*. В свойствах точки управления вы настраиваете подключения клиентов к **HTTP**.  
- *HTTPS*. В свойствах точки управления вы настраиваете подключения клиентов к **HTTPS**.  
- *E-HTTP*. В свойствах сайта на вкладке **Взаимодействие с клиентскими компьютерами** вы выбираете для системы сайта параметры **HTTPS или HTTP** и включаете параметр **Использовать сертификаты, созданные с помощью Configuration Manager, для систем сайтов HTTP**. Вы настраиваете точку управления HTTP, которая будет готова для взаимодействия HTTP и HTTPS (сценарии аутентификации токенов).  
    > [!Note]
    > Начиная с версии 1906, эта вкладка называется **Communication Security** (Безопасность обмена данными).<!-- SCCMDocs#1645 -->  

## <a name="azure-management-certificate"></a><a name="bkmk_azuremgmt"></a> Сертификат управления Azure

*Этот сертификат необходим для классических развертываний служб. Он не требуется для развертываний Azure Resource Manager.*

> [!Important]  
> Начиная с версии 1810 классическое развертывание службы в Azure не рекомендуется использовать в Configuration Manager. Перейдите на использование развертываний Azure Resource Manager для шлюза управления облачными клиентами. Дополнительные сведения см. в разделе [Планирование CMG](plan-cloud-management-gateway.md#azure-resource-manager).
>
> Начиная с версии Configuration Manager 1902, Azure Resource Manager — единственный механизм развертывания для новых экземпляров шлюза управления облачными клиентами. Этот сертификат не требуется в Configuration Manager версии 1902 или более поздних.<!-- 3605704 -->

Этот сертификат предоставляется на портале Azure при создании шлюза CMG в консоли Configuration Manager.

Чтобы создать шлюз CMG в Azure, сначала необходимо проверить подлинность точки подключения службы Configuration Manager в подписке Azure. Для проверки подлинности в классическом развертывании службы используется сертификат управления Azure. Администратор Azure отправляет этот сертификат в вашу подписку. Предоставьте этот сертификат во время создания шлюза CMG в консоли Configuration Manager.

Дополнительные сведения и инструкции по отправке сертификата управления см. в следующих статьях документации по Azure.

- [Облачные службы и сертификаты управления](https://docs.microsoft.com/azure/cloud-services/cloud-services-certs-create#what-are-management-certificates)  

- [Отправка сертификата управления службами Azure](https://docs.microsoft.com/azure/azure-api-management-certs)  

> [!IMPORTANT]
> Обязательно скопируйте идентификатор подписки, связанный с сертификатом управления. Он используется при создании шлюза CMG в консоли Configuration Manager.

## <a name="next-steps"></a>Дальнейшие шаги

- [Настройка шлюза управления облаком](setup-cloud-management-gateway.md)  

- [Часто задаваемые вопросы о шлюзе управления облачными клиентами](cloud-management-gateway-faq.md)  

- [Безопасность и конфиденциальность шлюза управления облаком](security-and-privacy-for-cloud-management-gateway.md)  
