---
title: Сайты резервного копирования
titleSuffix: Configuration Manager
description: Сведения о создании резервных копий сайтов до сбоя или потери данных в Configuration Manager.
ms.date: 01/08/2020
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: conceptual
ms.assetid: f7832d83-9ae2-4530-8a77-790e0845e12f
author: mestew
ms.author: mstewart
manager: dougeby
ms.openlocfilehash: 824eaeb939249e1bcc2ed21d5815a0a72dc54797
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81700272"
---
# <a name="back-up-a-configuration-manager-site"></a>Архивация сайта Configuration Manager

*Область применения: Configuration Manager (Current Branch)*

Подготовка вариантов по резервному копированию и восстановлению в целях исключения потери данных. Процедура резервного копирования и восстановления сайтов Configuration Manager помогает быстро восстанавливать сайты и иерархии с минимальной потерей данных.  

В разделах этой статьи описано, как создавать резервные копии сайтов. Сведения о восстановлении см. в статье [Recovery for Configuration Manager](recover-sites.md) (Восстановление сайтов Configuration Manager).  

<!--/SCCMdocs/issues/2108-->
>[!WARNING]
> Для Configuration Manager Site Recovery поддерживаются два метода резервного копирования:
>
> - Успешное выполнение задачи обслуживания **Резервное копирование сервера сайта**
> - Резервная копия базы данных сайта, восстановленная вручную


## <a name="considerations-before-creating-a-backup"></a>Предварительные требования  

-   При использовании группы доступности SQL Server Always On для размещения базы данных сайта: измените планы резервного копирования и восстановления, как описано в разделе [Подготовка к использованию SQL Server Always On](../deploy/configure/sql-server-alwayson-for-a-highly-available-site-database.md#changes-for-site-backup).  

-   Configuration Manager может восстановить базу данных сайта из задачи резервного копирования Configuration Manager. Он может также использовать резервную копию базы данных сайта, созданную с помощью другого процесса.   

     Например, базу данных сайта можно восстановить из резервной копии, созданной в составе плана обслуживания Microsoft SQL Server. Можно также использовать резервную копию, созданную с помощью Data Protection Manager (DPM) для резервного копирования базы данных сайта.  

-   Начиная с версии 1806 дополнительный сервер сайта следует устанавливать в *пассивном* режиме. Сервер сайта в пассивном режиме — это дополнение к существующему серверу сайта, который работает в *активном* режиме. Сервер сайта в пассивном режиме готов к использованию в любой момент, когда это необходимо. Дополнительные сведения см. в статье [Высокая доступность сервера сайта](../deploy/configure/site-server-high-availability.md). Хотя эта роль не отменяет необходимость планирования и реализации операций резервного копирования и восстановления, она значительно сокращает усилия, связанные с восстановлением сайта.  
  

####  <a name="using-data-protection-manager-to-back-up-your-site-database"></a>Использование Data Protection Manager для резервного копирования базы данных вашего сайта
System Center Data Protection Manager (DPM) можно использовать для резервного копирования базы данных сайта Configuration Manager.

Создайте группу защиты в DPM для компьютера базы данных сайта. На странице **Выбор членов группы** мастера создания групп защиты выберите службу модуля записи SMS в списке источников данных. Затем выберите базу данных сайта в качестве члена группы. Дополнительные сведения об использовании DPM см. в [библиотеке документации к Data Protection Manager](https://docs.microsoft.com/system-center/dpm).  

> [!IMPORTANT]  
>  Configuration Manager не поддерживает резервное копирование DPM для кластера SQL Server, использующего именованный экземпляр. Он поддерживает резервное копирование DPM для кластера SQL Server, который использует экземпляр SQL Server по умолчанию.  

После восстановления базы данных сайта выполните необходимые действия в программе установки для восстановления сайта. Чтобы использовать базу данных сайта, восстановленную с помощью Data Protection Manager, выберите вариант восстановления **Использовать базу данных сайта, восстановленную вручную**.  



## <a name="backup-maintenance-task"></a>Задача обслуживания "Резервное копирование"
Резервное копирование сайтов Configuration Manager можно автоматизировать путем создания расписания для предопределенной задачи обслуживания "Резервное копирование сервера сайта". Эта задача включает в себя следующие возможности:

-   выполняется по расписанию;
-   создает резервную копию базы данных сайта;
-   создает резервную копию конкретных разделов реестра;
-   создает резервную копию определенных файлов и папок;
-   создает резервную копию папки [CD.Latest](the-cd.latest-folder.md).   

Запланируйте выполнение задачи резервного копирования сайта по умолчанию как минимум раз в 5 дней. Это связано с тем, что для Configuration Manager *данные отслеживания изменений в SQL Server* хранятся 5 дней. Дополнительные сведения см. [здесь](recover-sites.md#sql-server-change-tracking-retention-period).

Чтобы упростить процесс резервного копирования, можно создать файл **AfterBackup.bat**. Этот сценарий автоматически реализует действия, выполняемые после резервного копирования, после успешного завершения задачи резервного копирования. Используйте файл AfterBackup.bat для архивации моментального снимка резервной копии в надежном расположении. Файл AfterBackup.bat также можно использовать для копирования файлов в папку резервной копии или для запуска других задач по резервному копированию.  

Можно создать резервную копию первичного сайта и сайта центра администрирования. У вторичных сайтов или серверов системы сайта отсутствуют задачи резервного копирования.

Запущенная служба резервного копирования Configuration Manager следует инструкциям, указанным в файле параметров резервного копирования: `<ConfigMgrInstallationFolder>\Inboxes\Smsbkup.box\Smsbkup.ctl`. Чтобы изменить механизм работы службы резервного копирования, в файл параметров резервного копирования можно внести изменения.  
> [!NOTE]
> Изменения файла **Smsbkup.ctl** будут применены после перезапуска службы SMS_SITE_VSS_WRITER на сервере сайта.

Сведения о состоянии резервного копирования сайта записываются в файл **Smsbkup.log** . Этот файл создается в конечной папке, указанной в свойствах задачи обслуживания "Резервное копирование сервера сайта".  

#### <a name="to-enable-the-site-backup-maintenance-task"></a>Включение задачи обслуживания "Резервное копирование сайта"  
1.  В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Конфигурация сайта** и выберите узел **Сайты**.  

2.  Выберите сайт, на котором требуется включить задачу обслуживания "Резервное копирование сайта".  

3.  На ленте щелкните **Задачи обслуживания сайта**.  

4.  Выберите задачу **Резервное копирование сервера сайта**, а затем нажмите кнопку **Изменить**.  

5.  Выберите параметр **Включить эту задачу**. Щелкните **Задать пути**, чтобы указать конечное расположение резервной копии. Можно выбрать один из следующих параметров.  

    > [!IMPORTANT]  
    >  Чтобы предотвратить несанкционированное изменение файлов резервной копии, храните эти файлы в безопасном месте. Наиболее безопасным расположением резервной копии является локальный диск, где папку с файлами можно защитить, настроив разрешения файлов NTFS. Configuration Manager не шифрует сохраняемые данные резервной копии.  

    -   **Локальный диск на сервере сайта для данных сайта и базы данных**. Указывает, что задача сохраняет файлы резервной копии для сайта и базы данных сайта по указанному пути на локальном диске сервера сайта. Создайте локальную папку перед запуском задачи резервного копирования. Учетная запись локальной системы на сервере сайта должна иметь разрешения файлов NTFS на **запись** в локальную папку резервной копии сервера сайта. Учетная запись локальной системы на компьютере под управлением SQL Server должна иметь разрешения NTFS на **запись** в папку резервной копии базы данных сайта.  

    -   **Сетевой путь (UNC-имя) для данных сайта и базы данных**. Указывает, что задача сохраняет файлы резервной копии для сайта и базы данных сайта по указанному сетевому пути. Создайте общую папку перед запуском задачи резервного копирования. Учетная запись компьютера сервера сайта должна иметь разрешение NTFS на **запись** и общий доступ к общей сетевой папке. Если SQL Server установлен на другом компьютере, учетная запись компьютера SQL Server должна иметь те же разрешения.  

    -   **Локальные диски на сервере сайта и сервере SQL Server**. Указывает, что задача сохраняет файлы резервной копии для сайта по указанному пути на локальном диске сервера сайта. Задача сохраняет файлы резервной копии для базы данных сайта по указанному пути на локальном диске сервера базы данных сайта. Создайте локальные папки перед запуском задачи резервного копирования. Учетная запись компьютера сервера сайта должна иметь разрешение NTFS на **запись** в папку, созданную на сервере сайта. Учетная запись компьютера SQL Server должна иметь разрешение NTFS на **запись** в папку, созданную на сервере базы данных сайта. Этот параметр доступен только в случае, если база данных сайта не установлена на сервере сайта.  

    > [!NOTE]  
    > Параметр перехода к папке расположения резервной копии доступен только в случае, если указан сетевой путь к папке резервной копии.  
    >  
    > Имя папки или общей папки, используемое для конечного расположения резервной копии, не поддерживает символы Юникода.  

6.  Настройте расписание для задачи резервного копирования сайта. Рекомендуется задать такое расписание, в соответствии с которым резервное копирование будет выполняться во время низкой нагрузки. При наличии иерархии рекомендуется задать расписание, которое выполняется по крайней мере два раза в неделю. В случае сбоя сайта такое расписание гарантирует максимальное сохранение данных.  

    Если консоль Configuration Manager запускается на сервере сайта, который настраивается для резервного копирования, задача резервного копирования использует для расписания местное время. Если консоль Configuration Manager запускается с другого компьютера, задача резервного копирования использует для расписания время в формате UTC.  

7.  Укажите, следует ли создавать оповещение в случае сбоя задачи резервного копирования сайта. При выборе этого параметра Configuration Manager будет создавать критическое оповещение о сбое резервного копирования. Эти оповещения отображаются в узле **Оповещения** в рабочей области **Наблюдение**.  

#### <a name="verify-that-the-backup-site-server-maintenance-task-is-running"></a>Проверка запуска задачи обслуживания "Резервное копирование сервера сайта"  

-   Проверьте метку времени в файлах в конечной папке резервной копии, созданной задачей обслуживания. Метка времени должна обновляться значением, совпадающим со значением времени, на которое было запланировано последнее выполнение задачи.  

-   Перейдите к узлу **Состояние компонента** в рабочей области **Наблюдение**. Просмотрите сообщения о состоянии для **SMS_SITE_BACKUP**. При успешном завершении резервного копирования сайта выводится сообщение с идентификатором **5035**. Это сообщение означает, что резервное копирование сайта завершено без ошибок.  

-   Если вы настраиваете задачу резервного копирования для создания оповещения в случае сбоя выполнения, просмотрите оповещения об ошибках резервного копирования в узле **Оповещения** рабочей области **Наблюдение**.  

-   На сервере сайта откройте проводник Windows и перейдите к папке `<ConfigMgrInstallationFolder>\Logs`. Просмотрите файл **Smsbkup.log** на наличие ошибок и предупреждений. При успешном завершении резервного копирования сайта в журнале отображается сообщение `Backup completed` с идентификатором `STATMSG: ID=5035`.  

    > [!TIP]  
    >  В случае сбоя задачи обслуживания "Резервное копирование" перезапустите задачу резервного копирования, остановив и повторно запустив службу Windows **SMS_SITE_BACKUP**.  



## <a name="archive-the-backup-snapshot"></a>Архивация моментального снимка резервной копии  
При первом выполнении задача резервного копирования создает моментальный снимок резервной копии. Этот снимок можно использовать для восстановления сервера сайта в случае его сбоя. Если задача резервного копирования выполняется повторно по расписанию, она создает снимок резервной копии, который перезаписывает предыдущий. Таким образом, для сайта существует только один моментальный снимок резервной копии. Получить снимки, созданные ранее, невозможно.  

Существует ряд следующих причин, по которым необходимо иметь несколько архивных моментальных снимков резервной копии.  

-   Вполне возможно, что носитель резервной копии может быть поврежден, потерян или на нем может находиться только часть резервной копии. Восстановление потерявшего работоспособность автономного первичного сайта из более ранней резервной копии является лучшим решением, чем восстановление без резервных копий. Для сервера сайта в иерархии резервная копия должна находиться в рамках срока хранения отслеживания изменений SQL Server. В противном случае резервная копия не требуется.  

-   Нарушение работоспособности сайта может оставаться незамеченным в течение нескольких циклов резервного копирования Может потребоваться воспользоваться моментальным снимком резервной копии, созданным до повреждения сайта. Этот принцип применим к автономному первичному сайту и сайтам в иерархии, где для резервной копии действует срок хранения отслеживания изменений SQL Server.  

-   У сайта может не быть никаких моментальных снимков резервных копий. Например, в случае сбоя задачи обслуживания "Резервное копирование сервера сайта". Поскольку перед началом процедуры создания резервной копии текущих данных задача резервного копирования удаляет предыдущий моментальный снимок резервной копии, допустимый моментальный снимок резервной копии отсутствует.  



## <a name="using-the-afterbackupbat-file"></a>Использование файла AfterBackup.bat  
После успешного резервного копирования сайта задача резервного копирования автоматически попытается запустить сценарий **AfterBackup.bat**. Создайте файл AfterBackup.bat вручную на сервере сайта в `<ConfigMgrInstallationFolder>\Inboxes\Smsbkup.box`. Если файл AfterBackup.bat находится в правильной папке, после завершения задачи резервного копирования он запустится автоматически.

Файл AfterBackup.bat позволяет архивировать моментальный снимок резервной копии в конце каждой операции резервного копирования. Он может автоматически выполнять другие действия после резервного копирования, которые не охватываются задачей обслуживания "Резервное копирование сервера сайта". Файл AfterBackup.bat интегрируется с операциями архивации и резервного копирования, обеспечивая тем самым архивацию каждого нового моментального снимка резервной копии.

Если файл AfterBackup.bat отсутствует, задача резервного копирования пропустит его без какого-либо воздействия на операцию резервного копирования. Чтобы убедиться в успешном запуске файла AfterBackup.bat задачей резервного копирования, в узле **Состояние компонента** в рабочей области **Наблюдение** просмотрите сообщения о состоянии для **SMS_SITE_BACKUP**. Если задача успешно запустила командный файл AfterBackup.bat, появится ИД сообщения **5040**.  

> [!TIP]  
>  Чтобы заархивировать файлы резервной копии сервера сайта с помощью файла AfterBackup.bat, необходимо использовать в этом пакетном файле средство командной строки для копирования. Это может быть средство [Robocopy](https://docs.microsoft.com/windows-server/administration/windows-commands/robocopy) в Windows Server. Например, создайте файл AfterBackup.bat, выполнив следующую команду: `Robocopy E:\ConfigMgr_Backup \\ServerName\ShareName\ConfigMgr_Backup /MIR`.  

Хотя исходно файл AfterBackup.bat предназначен для архивации моментальных снимков резервных копий, вы можете настроить этот файл для выполнения дополнительных задач по окончании каждой операции резервного копирования.  



##  <a name="supplemental-backup-tasks"></a>Дополнительные задачи архивации  
Задача обслуживания "Резервное копирование сервера сайта" предоставляет моментальный снимок резервной копии файлов сервера сайта и базы данных сайта. При создании стратегии резервного копирования необходимо принимать во внимание существование других элементов, для которых не создаются резервные копии. Следующие разделы содержат сведения о реализации стратегии резервного копирования Configuration Manager.  

### <a name="back-up-custom-reports"></a>Резервное копирование пользовательских отчетов   
При изменении предварительно определенных или созданных пользовательских отчетов в службах SQL Server Reporting Services следует создать резервную копию файлов базы данных сервера отчетов. Резервная копия должна содержать перечисленные ниже компоненты.
- Исходные файлы для отчетов и моделей
- Ключи шифрования
- Пользовательские сборки и расширения
- Файлы конфигурации
- Пользовательские представления SQL Server, используемые в пользовательских отчетах
- Пользовательские хранимые процедуры  

> [!IMPORTANT]  
>  Когда Configuration Manager обновляется до более поздней версии, предустановленные отчеты заменяются новыми отчетами. В случае изменения предопределенного отчета необходимо выполнить резервное копирование отчета, после чего восстановить его в службах Reporting Services.  

Дополнительные сведения о резервном копировании пользовательских отчетов в службах Reporting Services см. в разделе [Операции резервного копирования и восстановления для установки Reporting Services](https://docs.microsoft.com/sql/reporting-services/install-windows/backup-and-restore-operations-for-reporting-services).  

### <a name="back-up-content-files"></a>Резервное копирование файлов содержимого  
В библиотеке содержимого Configuration Manager хранятся все файлы содержимого для всех развертываний программного обеспечения. Библиотека содержимого находится на сервере сайта и в каждой точке распространения. Задача обслуживания "Резервное копирование сервера сайта" не выполняет резервное копирование библиотеки содержимого или исходных файлов пакета. При возникновении сбоя на сервере сайта сведения о библиотеке содержимого восстанавливаются в базе данных сайта, однако необходимо восстановить библиотеку содержимого и исходные файлы пакета.  

-   Перераспределение содержимого в точки распространения становится возможным только после того, как будет восстановлена библиотека содержимого. Когда запускается перераспределение содержимого, Configuration Manager копирует файлы из библиотеки содержимого на сервере сайта в точки распространения. Дополнительные сведения см. в статье [Библиотека содержимого](../../plan-design/hierarchy/the-content-library.md).  

-   Обновление содержимого в точках распространения становится возможным только после того, как будут восстановлены исходные файлы пакетов. Когда запускается обновление содержимого, Configuration Manager копирует новые или измененные файлы из источника пакета в библиотеку содержимого. Затем он копирует файлы в соответствующие точки распространения. Найти местоположение источника пакета для всех пакетов и приложений можно с помощью следующего запроса SQL Server в базе данных сайта: `SELECT * FROM v_Package`. Опознать сайт источника пакета можно по первым трем символам идентификатора пакета. Например, если пакет имеет идентификатор CEN00001, то код сайта источника — CEN. Исходные файлы пакетов должны восстанавливаться в том же месте, где они находились до сбоя.  

Убедитесь, что в резервную копию файловой системы сервера сайта включены и библиотека содержимого, и исходные файлы пакетов.  

### <a name="back-up-custom-software-updates"></a>Резервное копирование пользовательских обновлений программного обеспечения  
System Center Updates Publisher — это автономное средство, которое позволяет управлять пользовательскими обновлениями программного обеспечения. В качестве репозитория обновления программного обеспечения в Updates Publisher используется локальная база данных. Если вы используете Updates Publisher для управления пользовательскими обновлениями программного обеспечения, решите, нужно ли вам включать базу данных Updates Publisher в план резервного копирования. Дополнительные сведения см. в статье [System Center Updates Publisher](../../../sum/tools/updates-publisher.md).  

Для резервного копирования базы данных Updates Publisher используйте следующую процедуру.  

#### <a name="back-up-the-updates-publisher-database"></a>Резервное копирование базы данных Updates Publisher  

1.  На компьютере, на котором выполняется Updates Publisher, перейдите к файлу базы данных Updates Publisher **Scupdb.sdf** в папке `%USERPROFILE%\AppData\Local\Microsoft\System Center Updates Publisher 2011\5.00.1727.0000\`. У каждого пользователя, запускающего Updates Publisher, имеется собственная база данных.  

2.  Скопируйте файл базы данных в конечную папку резервного копирования. Например, если конечной папкой резервной копии является папка `E:\ConfigMgr_Backup`, можно скопировать файл базы данных Updates Publisher в папку `E:\ConfigMgr_Backup\SCUP`.  

    > [!TIP]  
    >  Если на компьютере имеется более одного файла базы данных, имеет смысл сохранить файл во вложенной папке, указывающей на профиль пользователя, с которым связан этот файл. Например, один файл базы данных может храниться в папке `E:\ConfigMgr_Backup\SCUP\User1`, а другой — в папке `E:\ConfigMgr_Backup\SCUP\User2`.  



## <a name="user-state-migration-data"></a>Данные миграции состояния пользователя  
Можно использовать последовательности задач Configuration Manager для записи и восстановления данных о пользовательском состоянии в сценариях развертывания операционной системы. Папки, в которых хранятся данные о пользовательском состоянии, указаны в свойствах точки миграции состояния. Для этих данных не создаются резервные копии при выполнении задачи обслуживания "Резервное копирование сервера сайта". Поэтому в плане резервного копирования необходимо предусмотреть ручное резервное копирование папок, в которых хранятся данные о миграции пользовательской среды.   

### <a name="determine-the-folders-used-to-store-user-state-migration-data"></a>Определение папок, в которых хранятся данные о миграции пользовательской среды  

1.  В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Конфигурация сайта** и выберите узел **Серверы и роли системы сайта**.  

2.  Выберите систему сайта, в которой размещена роль миграции состояния. Затем в области **Роли системы сайта** выберите **Точка миграции состояния**.  

3.  На ленте щелкните **Свойства**.  

4.  Папки, в которых хранятся данные о миграции пользовательской среды, перечислены в разделе **Сведения о папке** на вкладке **Общие** .  



## <a name="about-the-sms-writer-service"></a>Сведения о службе модуля записи SMS  
Модуль записи SMS — эта служба, которая взаимодействует со службой теневого копирования томов Windows (VSS) во время резервного копирования. Чтобы обеспечить успешное резервное копирование сайта Configuration Manager, сначала необходимо запустить службу модуля записи SMS.  

### <a name="process"></a>Процесс  
1. Модуль записи SMS регистрируется в службе VSS и выполняет привязку к ее интерфейсам и событиям. 
2. Когда служба VSS осуществляет широковещательную рассылку событий или передает определенные уведомления модулю записи SMS, модуль записи SMS отвечает на уведомление и выполняет соответствующее действие. 
3. Модуль записи SMS считывает файл параметров резервной копии **smsbkup.ctl**, расположенный в папке `<ConfigMgrInstallationPath>\inboxes\smsbkup.box`, и определяет файлы и данные, подлежащие резервному копированию. 
4. Модуль записи SMS создает метаданные, состоящие из различных компонентов, включая определенные данные из раздела и подразделов реестра SMS. 
    a. При получении запроса модуль отправляет метаданные в службу VSS. 
    b. Затем служба VSS отправляет метаданные запрашивающему приложению — диспетчеру резервного копирования Configuration Manager. 
5. Диспетчер резервного копирования выбирает данные для резервного копирования и отправляет их модулю записи SMS через службу VSS. 
6. Модуль записи SMS выполняет соответствующее действие для подготовки к резервному копированию. 
7. Позже, когда служба VSS готова для создания моментального снимка: а. она отправляет событие; б. модуль записи SMS останавливает все службы Configuration Manager; в. это гарантирует, что действия Configuration Manager зафиксированы во время создания моментального снимка. 
8. После создания моментального снимка модуль записи SMS перезапускает службы и действия.

Модуль записи SMS устанавливается автоматически. На момент запроса приложением VSS действий по резервному копированию и восстановлению модуль записи должен быть уже запущен.  

### <a name="writer-id"></a>Идентификатор модуля записи  
Модуль записи SMS имеет следующий идентификатор: **03ba67dd-dc6d-4729-a038-251f7018463b**.  

### <a name="permissions"></a>Разрешения  
Служба модуля записи SMS должна запускаться под учетной записью локальной системы.  

### <a name="volume-shadow-copy-service"></a>Служба теневого копирования томов  
Служба VSS — это набор API COM, который реализует платформу, позволяющую проводить резервное копирование томов одновременно с непрекращающимися действиями приложений в системе по записи в тома. Служба VSS предоставляет единообразный интерфейс, позволяющий координировать операции пользовательских приложений по обновлению данных на диске (служба записи SMS) с действиями приложений по резервному копированию (служба диспетчера резервного копирования). Дополнительные сведения см. в разделе [Служба теневого копирования томов](https://go.microsoft.com/fwlink/p/?LinkId=241968).  



## <a name="next-steps"></a>Дальнейшие шаги
Создав резервную копию, попробуйте с ее помощью [восстановить сайт](recover-sites.md). Это позволит вам ознакомиться с процессом восстановления до его активного использования. Вы также сможете убедиться, что резервное копирование выполнено успешно и по назначению.  
