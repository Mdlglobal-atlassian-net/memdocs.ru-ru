---
title: Сбор и восстановление данных о пользовательской среде
titleSuffix: Configuration Manager
description: Используйте последовательности задач Configuration Manager для сбора и восстановления данных о пользовательской среде в сценариях развертывания операционной системы.
ms.date: 08/17/2018
ms.prod: configuration-manager
ms.technology: configmgr-osd
ms.topic: conceptual
ms.assetid: d566d85c-bf7a-40e7-8239-57640a1db5f4
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: 93a39ba21b9e7d6cacfe59f763756aeef3736d52
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81707352"
---
# <a name="create-a-task-sequence-to-capture-and-restore-user-state-in-configuration-manager"></a>Создание последовательности задач для сбора и восстановления данных о пользовательской среде в Configuration Manager

 *Область применения: Configuration Manager (Current Branch)*

 Используйте последовательности задач Configuration Manager для сбора и восстановления данных о пользовательской среде в сценариях развертывания операционной системы. В этих сценариях требуется сохранить пользовательскую среду текущей ОС. В зависимости от создаваемого типа последовательности задач шаги записи и восстановления могут включаться в состав последовательности задач автоматически. В других случаях может потребоваться ручное добавление таких шагов. В этой статье описаны шаги, которые необходимо добавить в существующую последовательность задач для сбора и восстановления данных о пользовательской среде.  



## <a name="task-sequence-steps"></a>Шаги последовательности задач  

Чтобы собрать и восстановить данные о пользовательской среде, добавьте в последовательность задач следующие шаги.  

- [Запросить хранилище состояний](../understand/task-sequence-steps.md#BKMK_RequestStateStore). Этот шаг необходим, если пользовательская среда сохраняется в точке миграции состояния.  

- [Записать пользовательское состояние](../understand/task-sequence-steps.md#BKMK_CaptureUserState). На этом шаге записываются данные о пользовательской среде. Эти данные сохраняются в точке миграции состояния или на локальный диск с использованием жестких связей.  

- [Восстановить пользовательское состояние](../understand/task-sequence-steps.md#BKMK_RestoreUserState). Этот шаг восстанавливает данные пользовательского состояния на конечном компьютере. Он позволяет получить данные из точки миграции состояния или на локальном диске, если используются жесткие связи.  

- [Освободить хранилище состояний](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore). Этот шаг необходим, если пользовательская среда сохраняется в точке миграции состояния. Этот позволяет удалить данные из точки миграции состояния.  


 Ниже приведены процедуры добавления шагов последовательности задач для сбора и восстановления данных пользовательской среды. Дополнительные сведения о создании последовательностей задач см. в статье [Управление последовательностями задач для их автоматизации](manage-task-sequences-to-automate-tasks.md).  



## <a name="capture-the-user-state"></a>Запись пользовательской среды  

 Чтобы добавить шаги последовательности задач для сбора данных о пользовательской среде, выполните следующие действия.

1.  В списке **Последовательность задач** выберите последовательность задач и нажмите кнопку **Изменить**.  

2.  Если для хранения данных пользовательской среды используется точка миграции состояния, добавьте в последовательность задач шаг **Запросить хранилище состояний**. В **редакторе последовательности задач** щелкните **Добавить**. Наведите курсор на элемент **Пользовательская среда** и щелкните **Запросить хранилище состояний**. Настройте свойства и параметры этого шага и щелкните **Применить**. Дополнительные сведения о доступных параметрах см. в описании шага [Запросить хранилище состояний](../understand/task-sequence-steps.md#BKMK_RequestStateStore).  

3.  Добавьте шаг **Записать пользовательское состояние** в последовательность задач. В **редакторе последовательности задач** щелкните **Добавить**. Наведите курсор на элемент **Пользовательская среда** и щелкните **Записать пользовательское состояние**. Настройте свойства и параметры этого шага и щелкните **Применить**. Дополнительные сведения о доступных параметрах см. в описании шага [Записать пользовательское состояние](../understand/task-sequence-steps.md#BKMK_CaptureUserState).  

    > [!IMPORTANT]  
    >  Добавив этот шаг в последовательность задач, обязательно настройте переменную последовательности задач **OSDStateStorePath** с расположением для данных пользовательской среды. Если пользовательская среда сохраняется локально, не указывайте корневую папку, так как это может привести к сбою в последовательности задач. При хранении данных пользователей локально всегда следует использовать папку или подпапку. Дополнительные сведения об этой переменной см. в [описании переменных последовательности задач](../understand/task-sequence-variables.md#OSDStateStorePath).  

4.  Если для хранения используется точка миграции состояния, добавьте шаг **Освободить хранилище состояний** в последовательность задач. В **редакторе последовательности задач** щелкните **Добавить**. Наведите курсор на элемент **Пользовательская среда** и щелкните **Освободить хранилище состояний**. Настройте свойства и параметры этого шага и щелкните **Применить**. Дополнительные сведения о доступных параметрах см. в описании шага [Освободить хранилище состояний](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore).  

    > [!IMPORTANT]  
    >  Действие последовательности задач, выполняемое до шага **Освободить хранилище состояний** последовательности задач, должно быть успешно выполнено, прежде чем можно будет перейти к шагу **Освободить хранилище состояний**.  


 Выполните развертывание этой последовательности задач, чтобы выполнить сбор данных о пользовательской среде на конечном компьютере. Дополнительные сведения о развертывании последовательностей задач см. в статье [Развертывание последовательности задач](deploy-a-task-sequence.md).  



## <a name="restore-the-user-state"></a>Восстановление пользовательской среды  

 Чтобы добавить шаги последовательности задач, которые восстанавливают данные о пользовательской среде, выполните следующие действия.

1. В списке **Последовательность задач** выберите последовательность задач и нажмите кнопку **Изменить**.  

2. Добавьте шаг **Восстановить пользовательское состояние** в последовательность задач. В **редакторе последовательности задач** щелкните **Добавить**. Наведите курсор на элемент **Пользовательская среда** и щелкните **Восстановить пользовательское состояние**. Этот шаг устанавливает подключение к точке миграции состояния, если нужно. Настройте свойства и параметры этого шага и щелкните **Применить**. Дополнительные сведения о доступных параметрах см. в описании шага [Восстановить пользовательское состояние](../understand/task-sequence-steps.md#BKMK_RestoreUserState).  

   > [!Important]  
   >  Если у вас используется шаг [Записать пользовательское состояние](../understand/task-sequence-steps.md#BKMK_CaptureUserState) с вариантом **Записать все профили пользователей, используя стандартные параметры**, необходимо выбрать параметр **Восстановить профили локальных пользователей компьютера** в шаге **Восстановить пользовательское состояние**. В противном случае последовательность задач завершится сбоем.  

   > [!Note]  
   > Если для хранения данных о пользовательской среде вы используете локальные жесткие связи, то при сбое восстановления можно вручную удалить жесткие связи, которые были созданы для хранения данных. Чтобы автоматизировать это действие, из последовательности задач можно запустить средство USMTUtils с помощью шага [Выполнить из командной строки](../understand/task-sequence-steps.md#BKMK_RunCommandLine). Если для удаления жестких связей используется средство USMTUtils, добавьте шаг [Перезагрузить компьютер](../understand/task-sequence-steps.md#BKMK_RestartComputer) после запуска этого средства.  

3. Если для хранения данных о пользовательской среде используется точка миграции состояния, добавьте в последовательность задач шаг **Освободить хранилище состояний**. В **редакторе последовательности задач** щелкните **Добавить**. Наведите курсор на элемент **Пользовательская среда** и щелкните **Освободить хранилище состояний**. Настройте свойства и параметры этого шага и щелкните **Применить**. Дополнительные сведения о доступных параметрах см. в описании шага [Освободить хранилище состояний](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore).  

   > [!IMPORTANT]  
   >  Действие последовательности задач, выполняемое до шага **Освободить хранилище состояний** последовательности задач, должно быть успешно выполнено, прежде чем можно будет перейти к шагу **Освободить хранилище состояний**.  


 Разверните эту последовательность задач, чтобы восстановить пользовательскую среду на конечном компьютере. Дополнительные сведения о развертывании последовательностей задач см. в статье [Развертывание последовательности задач](deploy-a-task-sequence.md).  



## <a name="next-steps"></a>Дальнейшие шаги

[Мониторинг развертывания последовательности задач](monitor-operating-system-deployments.md#BKMK_TSDeployStatus)
