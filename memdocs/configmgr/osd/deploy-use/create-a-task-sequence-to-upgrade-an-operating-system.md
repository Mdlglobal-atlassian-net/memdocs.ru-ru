---
title: Создание последовательности задач для обновления ОС
titleSuffix: Configuration Manager
description: Автоматическое обновление с Windows 7 или более поздней версии до Windows 10 с помощью последовательности задач
ms.date: 07/26/2019
ms.prod: configuration-manager
ms.technology: configmgr-osd
ms.topic: conceptual
ms.assetid: 7591e386-a9ab-4640-8643-332dce5aa006
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: 8d87b2cde9a9fadb7326939b7fe473ba2a757e91
ms.sourcegitcommit: 48005a260bcb2b97d7fe75809c4bf1552318f50a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2020
ms.locfileid: "83430132"
---
# <a name="create-a-task-sequence-to-upgrade-an-os-in-configuration-manager"></a>Создание последовательности задач для обновления операционной системы в Configuration Manager

*Область применения: Configuration Manager (Current Branch)*

Используйте последовательности задач в Configuration Manager для автоматического обновления операционной системы на конечном компьютере. Это обновление может осуществляться с Windows 7 или более поздней версии до Windows 10 либо с Windows Server 2012 или более поздней версии до Windows Server 2016. Создайте последовательность задач, которая ссылается на пакет обновления операционной системы и любое другое устанавливаемое содержимое, например приложения или обновления программного обеспечения. Последовательность задач для обновления операционной системы входит в состав сценария [Обновление Windows до последней версии](upgrade-windows-to-the-latest-version.md).  


## <a name="prerequisites"></a>Предварительные условия

Прежде чем создавать последовательность задач, нужно выполнить следующие требования.

### <a name="required"></a>Обязательное

- В консоли Configuration Manager должен быть доступен [пакет обновления операционной системы](../get-started/manage-operating-system-upgrade-packages.md).  

- При обновлении до Windows Server 2016 выберите параметр **Ignore any dismissable compatibility messages** (Пропускать отклоняемые сообщения о совместимости) в шаге "Обновить операционную систему" последовательности задач. В противном случае обновление завершается ошибкой.  

### <a name="required-if-used"></a>Обязательно (если используется)  

- [Обновления программного обеспечения](../../sum/get-started/synchronize-software-updates.md) должны быть синхронизированы в консоли Configuration Manager.  

- [Приложения](../../apps/deploy-use/create-applications.md) должны быть добавлены в консоль Configuration Manager.  


## <a name="create-a-task-sequence-to-upgrade-an-os"></a><a name="BKMK_UpgradeOS"></a> Создание последовательности задач для обновления ОС  

Чтобы обновить операционную систему на клиентских компьютерах, можно создать последовательность задач и выбрать **Обновить операционную систему из пакета обновления** в мастере создания последовательности задач. Мастер добавит шаги последовательности задач по обновлению операционной системы, применению обновлений программного обеспечения и установке приложений.

1. В консоли Configuration Manager в рабочей области **Библиотека программного обеспечения** разверните узел **Операционные системы**, а затем выберите элемент **Последовательности задач**.  

2. На вкладке **Главная** на ленте в группе **Создать** выберите **Создать последовательность задач**.  

3. На странице **Создание последовательности задач** мастера создания последовательности задач выберите **Обновить операционную систему на основе пакета обновления** и нажмите кнопку **Далее**.  

4. На странице **Сведения о последовательности задач** настройте следующие параметры.  

    - **Имя последовательности задач**. Укажите имя последовательности задач.  

    - **Описание**. При необходимости укажите описание.  

5. На странице **Обновление операционной системы Windows** настройте следующие параметры.  

    - **Пакет обновления**. Укажите пакет обновления, содержащий исходные файлы обновления операционной системы. Убедитесь, что выбран правильный пакет обновления, просмотрев информацию в области **Свойства**. Дополнительные сведения см. в разделе [Управление пакетами обновления операционной системы](../get-started/manage-operating-system-upgrade-packages.md).  

    - **Индекс выпуска**. Если в пакете доступно несколько индексов выпусков операционной системы, выберите нужный индекс выпуска. По умолчанию мастер выбирает первый индекс.  

    - **Ключ продукта**. Введите ключ продукта Windows для устанавливаемой операционной системы Windows. Можно указать зашифрованные ключи многократной установки или стандартные ключи продукта. Если вы используете стандартный ключ продукта, разделите группы из пяти символов в ключе продукта дефисами (`-`). Например, так: `XXXXX-XXXXX-XXXXX-XXXXX-XXXXX`. При установке новой версии выпуска в рамках корпоративного лицензирования ключ продукта может не потребоваться.  

        > [!Note]  
        > Это может быть ключ многократной активации (MAK) или универсальный ключ многократной установки (GVLK). GVLK также называют ключом установки клиента для службы управления ключами (KMS). Дополнительные сведения см. в статье [Планирование активации корпоративных лицензий](https://docs.microsoft.com/windows/deployment/volume-activation/plan-for-volume-activation-client). Список ключей установки клиента KMS см. в [Приложении A](https://docs.microsoft.com/windows-server/get-started/kmsclientkeys) руководства по активации Windows Server.

    - **Пропускать маловажные сообщения о совместимости**. Выберите этот параметр при обновлении до Windows Server 2016. Если этот параметр не выбран, последовательность задач не удастся завершить, так как программа установки Windows будет ожидать, пока пользователь нажмет кнопку **Подтвердить** в диалоговом окне совместимости приложения Windows.  

6. На странице **Включить обновления** укажите, требуется ли устанавливать обязательные, все или никакие обновления ПО. Нажмите кнопку **Далее**. Если выбрана установка обновлений программного обеспечения, Configuration Manager устанавливает только те из них, которые относятся к коллекциям, в которые входит конечный компьютер.  

7. На странице **Установить приложения** укажите приложения, которые необходимо установить на конечный компьютер, а затем нажмите кнопку **Далее**. Если выбрано несколько приложений, можно настроить установку так, чтобы последовательность задач продолжала выполняться в случае сбоя установки определенного приложения.  

8. Завершите работу мастера.  

> [!Important]  
> При выполнении последовательности задач на устройстве клиент Configuration Manager создает несколько сценариев для управления поведением последовательности задач в различных ситуациях. Когда последовательность задач завершается, клиент не удаляет эти сценарии до перезагрузки компьютера. Эти файлы сценариев не содержат конфиденциальной информации.  

Шаблон последовательности задач по умолчанию для обновления до Windows 10 на месте включает дополнительные группы с действиями, которые рекомендуется выполнить до и после обновления. Эти действия являются общими для многих клиентов, которые успешно выполнили обновление устройств до Windows 10. Дополнительные сведения см. в описании рекомендуемых шагов последовательности задач для [подготовки к обновлению](#recommended-task-sequence-steps-to-prepare-for-upgrade) и [постобработки](#recommended-task-sequence-steps-for-post-processing).

Начиная с версии 1806 этот шаблон последовательности задач также включает группу с действиями, которые рекомендуется выполнить в случае сбоя процесса обновления. Эти действия упрощают устранение неполадок. Дополнительные сведения см. в разделе [Рекомендуемые действия в последовательности задач в случае сбоя](#recommended-task-sequence-steps-on-failure).<!--1358500-->  


## <a name="configure-pre-cache-content"></a>Настройка предварительного кэширования содержимого

<!--1021244-->
Функция предварительного кэширования для доступных развертываний последовательностей задач позволяет клиентам скачивать только необходимое содержимое обновления ОС, прежде чем пользователь установит последовательность задач.  

Дополнительные сведения см. в разделе [Настройка предварительного кэширования содержимого](configure-precache-content.md).


## <a name="recommended-task-sequence-steps-to-prepare-for-upgrade"></a>Рекомендуемые шаги последовательности задач для подготовки к обновлению

Шаблон последовательности задач по умолчанию для обновления до Windows 10 на месте содержит дополнительные группы с действиями, которые рекомендуется выполнить до процесса обновления. Эти действия в группе **Подготовка к обновлению** являются общими для многих клиентов, которые успешно выполнили обновление устройств до Windows 10. Если у вас есть последовательность задач без этих действий, добавьте их вручную в последовательность задач в группе **Подготовка к обновлению**.  

### <a name="battery-checks"></a>Проверки батареи

Добавьте шаги в эту группу, чтобы проверить, использует ли компьютер питание от батарей или от сети. Чтобы выполнить эту проверку, этому действию требуется пользовательский сценарий или программа.

#### <a name="battery-check-example"></a>Пример проверки аккумулятора

С помощью WbemTest подключитесь к пространству имен `root\cimv2`. Затем выполните следующий запрос:

`Select BatteryStatus From Win32_Battery where BatteryStatus != 2`

Если запрос не возвращает результаты, значит устройство работает от батареи. В противном случае устройство подключено к источнику питания с помощью кабеля.  

### <a name="networkwired-connection-checks"></a>Проверки подключения к сети и проводного подключения

Добавьте шаги в эту группу, чтобы проверить, подключен ли компьютер к сети и не использует ли он беспроводное подключение. Чтобы выполнить эту проверку, этому действию требуется пользовательский сценарий или программа.

#### <a name="network-check-example"></a>Пример проверки подключения по сети

С помощью WbemTest подключитесь к пространству имен `root\cimv2`. Затем выполните следующий запрос:

`Select * From Win32_NetworkAdapter Where NetConnectionStatus = 2 and PhysicalAdapter = 'True' and NetConnectionID = 'Wi-Fi'`

Если запрос не возвращает результаты, значит, устройство работает от Wi-Fi. В противном случае устройство подключено к сети с помощью кабеля.

### <a name="remove-incompatible-applications"></a>Удаление несовместимых приложений

Добавьте шаги в эту группу, чтобы удалить все приложения, несовместимые с этой версией Windows 10. Методы удаления приложений могут различаться.  

Если приложение использует установщик Windows, скопируйте командную строку **программы удаления** из вкладки **Программы** в свойствах типа развертывания установщика Windows приложения. Затем добавьте шаг **Выполнить из командной строки** в эту группу с помощью командной строки программы удаления. Пример.

`msiexec /x {150031D8-1234-4BA8-9F52-D6E5190D1CBA} /q`  

### <a name="remove-incompatible-drivers"></a>Удаление несовместимых драйверов

Добавьте шаги в эту группу, чтобы удалить все драйверы, несовместимые с этой версией Windows 10.  

### <a name="removesuspend-third-party-security"></a>Удаление и приостановка сторонних программ защиты

Добавьте шаги в эту группу, чтобы удалить или приостановить сторонние программы защиты, например, антивирус.  

При использовании сторонней программы шифрования дисков укажите ее драйвер шифрования для установщика Windows с помощью `/ReflectDrivers` [параметра командной строки](https://docs.microsoft.com/windows-hardware/manufacture/desktop/windows-setup-command-line-options#reflectdrivers). Добавьте шаг [Задать переменную последовательности задач](../understand/task-sequence-steps.md#BKMK_SetTaskSequenceVariable) в последовательность задач для этой группы. Задайте в качестве переменной последовательности задач **OSDSetupAdditionalUpgradeOptions**. Укажите путь к драйверу в качестве значения переменной `/ReflectDrivers`. Эта [переменная последовательности задач](../understand/task-sequence-variables.md#OSDSetupAdditionalUpgradeOptions) добавляет командную строку программы установки Windows, используемую последовательностью задач. Обратитесь к поставщику программного обеспечения, чтобы получить дополнительные рекомендации по этому процессу.  

### <a name="download-package-content-task-sequence-step"></a>Шаг последовательности задач "Скачать содержимое пакета"  

Используйте шаг [Скачать содержимое пакета](../understand/task-sequence-steps.md#BKMK_DownloadPackageContent) перед шагом **Обновить операционную систему** в следующих сценариях:  

- Вы используете единственную последовательность задач обновления для обеих платформ — x86 и x64. Включите два шага **Скачать содержимое пакета** в группу **Подготовка к обновлению**. Задайте условия для каждого шага, чтобы определить архитектуру клиента. Это условие позволяет скачивать только соответствующий пакет обновления ОС в рамках шага. Настройте каждый шаг **Скачать содержимое пакета** так, чтобы использовалась одна и та же переменная, и используйте переменную для пути к носителю в шаге **Обновить операционную систему** .  

- Для динамического скачивания применимого пакета драйверов используйте два шага загрузки **Скачать содержимое пакета** с условиями определения соответствующего типа оборудования для каждого пакета драйверов. Настройте каждый шаг **Скачать содержимое пакета** для использования одной переменной. Затем используйте эту переменную для значения **Промежуточное содержимое** в разделе драйверов в шаге **Обновить операционную систему**.  

    > [!NOTE]  
    > Configuration Manager добавляет к имени этой переменной числовой суффикс. Например, если задать переменную `%mycontent%` в качестве пользовательской переменной, клиент сохраняет все указанное содержимое в этом расположении. При ссылке на эту переменную в последующем шаге, таком как **Обновить операционную систему**, используйте ее с числовым суффиксом. В этом примере используется переменная `%mycontent01%` или `%mycontent02%`, где номер соответствует порядку этого содержимого на шаге **Скачать содержимое пакета**.  


## <a name="recommended-task-sequence-steps-for-post-processing"></a>Рекомендуемые шаги последовательности задач для постобработки

После создания последовательности задач добавьте дополнительные шаги в группу **Постобработка** последовательности задач.  

> [!NOTE]  
> Эта последовательность задач не является линейной. Существуют условия для шагов, которые могут повлиять на результаты последовательности задач. Это поведение зависит от успешности обновления клиентского компьютера или необходимости отката клиентского компьютера к предыдущей версии ОС.  

Шаблон последовательности задач по умолчанию для обновления до Windows 10 на месте содержит дополнительные группы с действиями, которые рекомендуется выполнить после процесса обновления. Эти действия в группе **Постобработка** являются общими для многих клиентов, которые успешно выполнили обновление устройств до Windows 10. Если у вас есть последовательность задач без этих действий, добавьте их вручную в последовательность задач в группе **Постобработка**.  

### <a name="apply-setup-based-drivers"></a>Применение драйверов на основе установки

Добавьте шаги в эту группу, чтобы установить драйверы (.exe) из пакетов.  

### <a name="installenable-third-party-security"></a>Установка и включение сторонних программ защиты

Добавьте шаги в эту группу, чтобы установить или включить сторонние программы защиты, например антивирус.  

### <a name="set-windows-default-apps-and-associations"></a>Настройка приложений и сопоставлений файлов в Windows по умолчанию

Добавьте шаги в эту группу, чтобы настроить связи между приложениями и файлами Windows по умолчанию.

1. Подготовьте компьютер-образец с нужными связями приложения.
1. Запустите следующую команду, чтобы выполнить экспорт:  
    `dism /online /Export-DefaultAppAssociations:"%UserProfile%\Desktop\DefaultAppAssociations.xml"`  
1. Добавьте XML-файл в пакет.
1. Добавьте шаг [Выполнить из командной строки](../understand/task-sequence-steps.md#BKMK_RunCommandLine) в эту группу. Укажите пакет, который содержит XML-файл, а затем укажите следующую командную строку:  
    `dism /online /Import-DefaultAppAssociations:DefaultAppAssociations.xml`  

Дополнительные сведения см. в статье [Export or Import Default Application Associations](/windows-hardware/manufacture/desktop/export-or-import-default-application-associations) (Экспорт и импорт связей приложений по умолчанию).

### <a name="apply-customizations-and-personalization"></a>Применение персонализации и личных настроек

Добавьте шаги в эту группу, чтобы применить настройки меню "Пуск", например для создания групп программ. Дополнительные сведения см. в статье [Customize the Start Screen](/windows-hardware/manufacture/desktop/customize-the-start-screen) (Настройка экрана запуска).  


## <a name="optional-task-sequence-steps-for-rollback"></a>Дополнительные шаги последовательности задач для отката  

В случае возникновения проблем с обновлением после перезагрузки компьютера программа установки Windows выполнит откат обновления до предыдущей операционной системы. Затем последовательность задач продолжит выполнять шаги в группе **Откат**. После создания последовательности задач при необходимости добавьте дополнительные шаги в этой группе. Например, можно отменить изменения, внесенные в систему в группе "Подготовка к обновлению", такие как удаление несовместимого программного обеспечения.


## <a name="recommended-task-sequence-steps-on-failure"></a>Рекомендуемые действия в последовательности задач в случае сбоя

<!--1358500-->
Начиная с версии 1806 шаблон последовательности задач по умолчанию для обновления до Windows 10 на месте включает группу **Действия для запуска в случае сбоя**. Эта группа включает рекомендуемые действия, которые необходимо выполнить в случае сбоя обновления. Эти действия упрощают устранение неполадок.

### <a name="collect-logs"></a>Сбор данных журналов

добавьте шаги в эту группу, чтобы собирать журналы от клиента.  

- Обычно нужно скопировать файлы журналов в сетевую папку. Для установки этого подключения, используйте шаг [Подключить к сетевой папке](../understand/task-sequence-steps.md#BKMK_ConnectToNetworkFolder).  

- Чтобы скопировать файлы, воспользуйтесь настраиваемым скриптом или служебной программой, выбрав шаг [Выполнить из командной строки](../understand/task-sequence-steps.md#BKMK_RunCommandLine) или [Запустить сценарий PowerShell](../understand/task-sequence-steps.md#BKMK_RunPowerShellScript).  

- Файлы, которые нужно собрать, могут содержать следующие журналы:  
     `%_SMSTSLogPath%\*.log`  
     `%SystemDrive%\$Windows.~BT\Sources\Panther\setupact.log`  

- См. дополнительные сведения о [setupact.log и других журналах программы установки Windows](https://docs.microsoft.com/windows/deployment/upgrade/log-files).  

- Дополнительные сведения о журналах клиента Configuration Manager см. в разделе [Журналы клиента Configuration Manager](../../core/plan-design/hierarchy/log-files.md#BKMK_ClientLogs).  

- Дополнительные сведения о **_SMSTSLogPath** и других полезных переменных см. в статье, посвященной [переменным последовательности задач](../understand/task-sequence-variables.md).  

### <a name="run-diagnostic-tools"></a>Запуск средств диагностики

добавьте шаги в эту группу, чтобы запустить дополнительные средства диагностики. Автоматизируйте сбор дополнительных сведений из системы, выполняемый сразу после сбоя, в этих средствах.  

Одним из таких средств является Windows [SetupDiag](https://docs.microsoft.com/windows/deployment/upgrade/setupdiag). Это автономное средство диагностики, которое можно использовать, чтобы узнать причину сбоя при обновлении Windows 10.  

- В Configuration Manager [создайте пакет](../../apps/deploy-use/packages-and-programs.md#create-a-package-and-program) для этого средства.  

- Добавьте в эту группу шаг [Выполнить из командной строки](../understand/task-sequence-steps.md#BKMK_RunCommandLine) для последовательности задач. Используйте параметр **Пакет**, чтобы указать ссылку на это средство. Ниже представлен пример **командной строки**:  
    `SetupDiag.exe /Output:"%_SMSTSLogPath%\SetupDiagResults.log" /Mode:Online`  


## <a name="additional-recommendations"></a>Дополнительные рекомендации

### <a name="windows-documentation"></a>Документация по Windows

Ознакомьтесь с документацией по Windows по [разрешению ошибок обновления до Windows 10](https://docs.microsoft.com/windows/deployment/upgrade/resolve-windows-10-upgrade-errors). В этой статьей также содержится подробная информация о процессе обновления.  

### <a name="check-minimum-disk-space"></a>Проверка наличия минимального места на диске

В шаге по умолчанию **Проверить готовность** включите параметр **Ensure minimum free disk space (MB)** (Обеспечить минимальное свободное место на диске (МБ)). Установите значение по крайней мере **16384** (16 ГБ) для пакета обновления 32-разрядной системы компьютера или **20480** (20 ГБ) для 64-разрядной.  

### <a name="retry-downloading-policy"></a>Политика повторного скачивания

Используйте [переменную последовательности задач](../understand/task-sequence-variables.md#SMSTSDownloadRetryCount) **SMSTSDownloadRetryCount** для повторения политики скачивания. В настоящее время по умолчанию клиент выполняет повторение дважды. Этой переменной задано значение 2. Если ваши клиенты не используют сетевое проводное корпоративное подключение, дополнительные повторные попытки подключения помогут клиенту получить политику. Использование этой переменной не вызывает негативных побочных эффектов за исключением отложенного сбоя, если не удалось скачать политику.<!--501016--> Кроме того, увеличьте переменную **SMSTSDownloadRetryDelay** с 15 секунд по умолчанию.  

### <a name="perform-an-inline-compatibility-assessment"></a>Выполнение встроенной оценки совместимости

1. Добавьте второй шаг **Обновление операционной системы** на раннем этапе в группе **Подготовка к обновлению**.  

    1. Назовите его *Оценка обновления*.
    1. Укажите один и тот же пакет обновления, а затем включите параметр **Выполнить проверку совместимости с программой установки Windows без запуска обновления**.
    1. Не включайте параметр **Продолжить при возникновении ошибки** на вкладке "Параметры".  

1. После этого сразу же выполните шаг *Оценка обновления* и добавьте шаг **Выполнить из командной строки**. Укажите следующую командную строку:

    `cmd /c exit %_SMSTSOSUpgradeActionReturnCode%`

1. На вкладке **Параметры** укажите перечисленные ниже условия:

    `Task Sequence Variable _SMSTSOSUpgradeActionReturnCode not equals 3247440400`

Этот код возврата является десятичным эквивалентом MOSETUP_E_COMPAT_SCANONLY (0xC1900210), который является успешной проверкой совместимости. Если шаг *Оценка обновления* завершится успешно и вернет этот код, этот шаг в последовательности задач пропускается. В противном случае, если шаг оценки возвращает любой другой код возврата, на этом шаге последовательность задач завершается со сбоем с кодом из проверки совместимости программы установки Windows. Дополнительные сведения о **_SMSTSOSUpgradeActionReturnCode** см. в статье о [переменных последовательности задач](../understand/task-sequence-variables.md#SMSTSOSUpgradeActionReturnCode).

Дополнительные сведения см. в разделе [Обновление операционной системы](../understand/task-sequence-steps.md#BKMK_UpgradeOS).  

### <a name="convert-from-bios-to-uefi"></a>Преобразование из BIOS в UEFI

Если вы хотите изменить устройство с BIOS на UEFI во время этой последовательности задач, см. раздел [Переход от BIOS к UEFI при обновлении на месте](task-sequence-steps-to-manage-bios-to-uefi-conversion.md#bkmk_ipu).  

### <a name="manage-bitlocker"></a>Управление BitLocker

<!--SCCMDocs issue #494-->
Если вы используете шифрование диска BitLocker, то программа установки Windows по умолчанию автоматически приостанавливает его работу во время обновления. Начиная с Windows 10 версии 1803 программа установки включает параметр командной строки `/BitLocker`, который позволяет управлять этим поведением. Если в соответствии с вашими требованиями к защите не допускается отключение шифрования диска, используйте [переменную последовательности задач](../understand/task-sequence-variables.md#OSDSetupAdditionalUpgradeOptions) **OSDSetupAdditionalUpgradeOptions** в группе **Подготовка к обновлению**, чтобы включить `/BitLocker TryKeepActive`. Дополнительные сведения см. в статье [Параметры командной строки программы установки Windows](https://docs.microsoft.com/windows-hardware/manufacture/desktop/windows-setup-command-line-options#bitlocker).

### <a name="remove-default-apps"></a>Удаление стандартных приложений

<!--SCCMDocs issue #526-->
Некоторые клиенты удаляют подготовленные по умолчанию приложения в Windows 10. Например, приложение "Погода Bing" или Microsoft Solitaire Collection. В некоторых случаях эти приложения появляются повторно после обновления Windows 10. Дополнительные сведения см. в разделе [Как предотвратить повторное появление удаленных приложений в Windows 10](https://docs.microsoft.com/windows/application-management/remove-provisioned-apps-during-update).

Добавьте шаг **Выполнить из командной строки** в последовательность задач в группе **Подготовка к обновлению**. Укажите такую команду как в следующем примере:

`cmd /c reg add "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Appx\AppxAllUserStore\Deprovisioned\Microsoft.BingWeather_8wekyb3d8bbwe" /f`
