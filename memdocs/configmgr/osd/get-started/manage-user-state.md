---
title: 'Управление пользовательской средой '
titleSuffix: Configuration Manager
description: Использование средства миграции пользовательской среды в Configuration Manager для записи и восстановления данных о пользовательской среде в сценариях развертывания операционной системы.
ms.date: 01/23/2017
ms.prod: configuration-manager
ms.technology: configmgr-osd
ms.topic: conceptual
ms.assetid: d8d5c345-1e91-410b-b8a9-0170dcfa846e
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: 70c15fb3a108b22ffacad69d6a67bef3b2d29952
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81708832"
---
# <a name="manage-user-state-in-configuration-manager"></a>Управление пользовательской средой в Configuration Manager

*Область применения: Configuration Manager (Current Branch)*

Вы можете использовать последовательности задач Configuration Manager для записи и восстановления данных о пользовательской среде в тех сценариях развертывания операционной системы, где требуется сохранить пользовательскую среду текущей ОС. Пример.  

- Развертывания, когда требуется собрать данные о пользовательской среде с одного компьютера и восстановить их на другом компьютере;  

- развертывание обновлений, когда требуется собрать и восстановить данные о пользовательской среде на одном компьютере.  

Configuration Manager применяет средство миграции пользовательской среды (USMT) версии 10.0 для управления миграцией данных о пользовательской среде с исходного компьютера на конечный после завершения установки операционной системы. Дополнительные сведения об общих сценариях миграции для USMT 10.0 см. в статье  [Распространенные сценарии миграции](https://docs.microsoft.com/windows/deployment/usmt/usmt-common-migration-scenarios).

Сведения о сборе и восстановлении данных пользователя см. в следующих разделах.

## <a name="store-user-state-data"></a><a name="BKMK_StoringUserData"></a> Сохранение данных о пользовательской среде

 При сборе данных о пользовательской среде их можно сохранить на конечном компьютере или на точке миграции состояния. Чтобы сохранить данные пользовательской среды на точке миграции состояния, необходимо использовать сервер системы сайта Configuration Manager, на котором размещается роль системы сайта точки миграции состояния. Чтобы сохранить данные пользовательской среды на конечном компьютере, необходимо задать для последовательности задач локальное сохранение данных с помощью связей.

> [!NOTE]
> Связи, используемые для сохранения пользовательской среды в локальной системе, называются жесткими связями. Жесткие связи — это функция средства миграции пользовательской среды USMT 10.0, которая проверяет наличие на компьютере файлов и параметров пользователей, а затем создает каталог жестких связей для таких файлов. Жесткие связи затем используются для восстановления данных пользователя после развертывания операционной системы.

> [!IMPORTANT]
> Для сохранения данных пользовательской среды нельзя одновременно использовать точку миграции состояния и жесткие связи.

Собранные данные о пользовательской среде можно сохранить одним из следующих способов.  

- Данные пользовательской среды можно сохранить удаленно, настроив точку миграции состояния. Последовательность задач **Запись** отправляет данные на точку миграции состояния. Затем после развертывания операционной системы последовательность задач **Восстановление** получает данные и восстанавливает пользовательскую среду на конечном компьютере.  

- Данные пользовательской среды можно сохранить локально, указав конкретное расположение. В этом случае последовательность задач **Запись** копирует данные пользователя в определенное расположение на конечном компьютере. После развертывания операционной системы последовательность задач **Восстановление** получает данные пользователя из этого расположения.  

- Можно указать жесткие связи, которые будут использоваться для восстановления данных пользователей в исходное расположение. В этом случае данные пользовательской среды остаются на диске, тогда как старая операционная система с него удаляется. После развертывания новой операционной системы последовательность задач **Восстановление** использует жесткие связи для восстановления данных о пользовательской среде в исходном расположении.  

### <a name="store-user-data-on-a-state-migration-point"></a><a name="BKMK_UserDataSMP"></a> Сохранение данных пользователя в точке миграции состояния

 Чтобы сохранить данные о пользовательской среде на точке миграции состояния, необходимо выполнить следующие действия:  

1. Выполните инструкции из раздела[Configure a state migration point](#BKMK_StateMigrationPoint) для сохранения данных о пользовательской среде.  

1. Выполните операции из раздела[Create a computer association](#BKMK_ComputerAssociation) между исходным и конечным компьютером. Ассоциацию необходимо создать до начала сбора данных о пользовательской среде на исходном компьютере.  

1. [Создайте последовательность задач для записи и восстановления пользовательского состояния](../deploy-use/create-a-task-sequence-to-capture-and-restore-user-state.md). В частности, необходимо добавить следующие шаги последовательности задач для записи данных пользователя с компьютера, их сохранения на точке миграции состояния и восстановления на компьютере:  

    - Используйте шаг [Запросить хранилище состояний](../understand/task-sequence-steps.md#BKMK_RequestStateStore), чтобы запросить доступ к точке миграции состояния во время записи состояния с компьютера или восстановления его на компьютер.  

    - Используйте шаг [Записать пользовательское состояние](../understand/task-sequence-steps.md#BKMK_CaptureUserState) для сбора и сохранения данных о пользовательской среде на точке миграции состояния.  

    - Используйте шаг [Восстановить пользовательское состояние](../understand/task-sequence-steps.md#BKMK_RestoreUserState) для восстановления пользовательской среды на целевом компьютере за счет получения данных из точки миграции состояния.  

    - Используйте шаг [Освободить хранилище состояний](../understand/task-sequence-steps.md#BKMK_ReleaseStateStore), чтобы уведомить точку миграции состояния о том, что действие записи или восстановления выполнено.  

### <a name="store-user-data-locally"></a><a name="BKMK_UserDataDestination"></a> Хранение данных пользователя в локальной среде

 Для локального хранения данных о пользовательской среде выполните следующие действия:  

- [Создайте последовательность задач для записи и восстановления пользовательского состояния](../deploy-use/create-a-task-sequence-to-capture-and-restore-user-state.md). В частности, необходимо добавить следующие шаги последовательности задач для записи данных пользователя с компьютера и их восстановления на компьютере с использованием жестких связей:

  - Используйте шаг [Записать пользовательское состояние](../understand/task-sequence-steps.md#BKMK_CaptureUserState) для сбора и сохранения данных о пользовательской среде в локальной папке с помощью жестких связей.  

  - Используйте шаг [Восстановить пользовательское состояние](../understand/task-sequence-steps.md#BKMK_RestoreUserState) для восстановления пользовательской среды на целевом компьютере за счет получения данных с помощью жестких связей.  

    > [!NOTE]
    > Данные пользовательской среды, на которые ссылаются жесткие связи, остаются на компьютере, после того как последовательность задач удалит старую операционную систему. Это данные, которые используются для восстановления пользовательской среды при развертывании операционной системы.  

## <a name="configure-a-state-migration-point"></a><a name="BKMK_StateMigrationPoint"></a> Configure a state migration point

Точка миграции состояния хранит данные пользовательской среды, собираемые на одном компьютере и затем восстанавливаемые на другом. Следует учитывать, что при сборе параметров пользователей для развертывания на одном компьютере (например, при обновлении операционной системы на конечном компьютере) данные можно сохранить как на этом же компьютере с помощью жестких связей, так и в точке миграции состояния. В некоторых случаях (при создании в процессе развертывания хранилища состояний) Configuration Manager автоматически создает связь между хранилищем и конечным компьютером. Ниже приведены способы настройки точки миграции состояния для хранения данных пользовательской среды:  

- создание нового сервера системы сайта для точки миграции состояния с помощью **мастера создания сервера системы сайта** ;  

- добавление точки миграции среды на существующий сервер с помощью **мастера добавления ролей системы сайта** .  

  При использовании этих мастеров потребуется указать для точки миграции состояния следующие сведения:  

- папки для хранения данных пользовательской среды;  

- максимальное число клиентов, которые могут сохранять данные на точке миграции состояния;  

- минимальный объем свободного пространства для хранения данных пользовательской среды на точке миграции состояния;  

- политику удаления для роли (можно задать немедленное удаление данных пользовательской среды после восстановления на компьютере или указать интервал удаления (в днях) после восстановления данных пользователя на компьютере);  

- будет ли точка миграции состояния отвечать только на запросы восстановления данных о пользовательской среде. Если выбрать этот вариант, точку миграции состояния нельзя будет использовать для сохранения данных пользовательской среды.  

  Дополнительные сведения о точке миграции состояния и действия по ее настройке см. в статье [Точка миграции состояния](prepare-site-system-roles-for-operating-system-deployments.md#BKMK_StateMigrationPoints).  

## <a name="create-a-computer-association"></a><a name="BKMK_ComputerAssociation"></a> Create a computer association

Создайте ассоциацию компьютеров, чтобы определить связь между исходным и конечным компьютером, когда вы устанавливаете операционную систему на новом оборудовании и хотите собрать и восстановить параметры пользователей. Исходный компьютер — это существующий компьютер, для управления которым используется Configuration Manager. При развертывании новой операционной системы на конечном компьютере исходный компьютер является источником пользовательской среды, переносимой на конечный компьютер.  

> [!NOTE]  
> Создание ассоциации компьютеров, расположенных на родительском сайте Configuration Manager, с компьютерами, расположенными на дочернем сайте, не поддерживается. Ассоциации компьютеров относятся к сайтам и не реплицируются.  

### <a name="to-create-a-computer-association"></a>Создание ассоциации компьютеров

1. В консоли Configuration Manager щелкните элемент **Активы и соответствие**.  

1. В рабочей области **Активы и соответствие** щелкните **Миграция пользовательской среды**.  

1. На вкладке **Главная** в группе **Создать** щелкните **Создать ассоциацию компьютеров**.  

1. На вкладке **Ассоциация компьютеров** диалогового окна **Свойства ассоциации компьютеров** укажите исходный компьютер, с которого требуется собрать данные о пользовательской среде, и конечный компьютер, на котором предполагается восстановить эти данные.  

1. На вкладке **Учетные записи пользователей** укажите учетные записи пользователей, которые требуется перенести на конечный компьютер. Укажите один из следующих параметров.  

    - **Записать и восстановить все учетные записи пользователей**. Этот параметр записывает и восстанавливает все учетные записи пользователей. Используйте этот параметр для создания нескольких ассоциаций с одним и тем же исходным компьютером.  

    - **Записать все учетные записи пользователей и восстановить указанные**. Этот параметр записывает все учетные записи на исходном компьютере и восстанавливает на конечном компьютере только указанные учетные записи. Кроме того, этот параметр можно использовать, если требуется создать несколько ассоциаций с одним и тем же исходным компьютером.  

    - **Записать и восстановить указанные учетные записи пользователей**. Этот параметр записывает и восстанавливает только указанные учетные записи. При выборе этого параметра нельзя создать несколько ассоциаций с одним и тем же исходным компьютером.  

## <a name="restore-user-state-data-when-an-operating-system-deployment-fails"></a><a name="BKMK_MigrationFails"></a> Восстановление данных о пользовательской среде при сбое развертывания операционной системы

Если происходит сбой развертывания операционной системы, используйте функцию LoadState USMT 10.0 для извлечения данных о пользовательской среде, которые были собраны в ходе развертывания. Это относится как к данным, которые хранятся на точке миграции состояний, так и к данным, хранящимся локально на конечном компьютере. Дополнительные сведения о данной функции USMT см. в разделе [Синтаксис LoadState](https://docs.microsoft.com/windows/deployment/usmt/usmt-loadstate-syntax).
