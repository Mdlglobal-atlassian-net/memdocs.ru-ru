---
title: Настройка инфраструктуры сертификатов
titleSuffix: Configuration Manager
description: Сведения о настройке регистрации сертификатов в Configuration Manager.
ms.date: 07/25/2017
ms.prod: configuration-manager
ms.technology: configmgr-protect
ms.topic: conceptual
ms.assetid: 29ae59b7-2695-4a0f-a9ff-4f29222f28b3
author: mestew
ms.author: mstewart
manager: dougeby
ms.openlocfilehash: fe34768de48f52dd4872a63ccf353fda1c691a44
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81705802"
---
# <a name="configure-certificate-infrastructure"></a>Настройка инфраструктуры сертификатов

*Область применения: Configuration Manager (Current Branch)*

Сведения о настройке инфраструктуры сертификатов в Configuration Manager. Перед началом работы проверьте выполнение всех необходимых условий, перечисленных в статье [Необходимые условия для профилей сертификатов в System Center Configuration Manager](../../protect/plan-design/prerequisites-for-certificate-profiles.md).  

Выполните эти действия, чтобы настроить инфраструктуру для сертификатов SCEP (или PFX).

## <a name="step-1---install-and-configure-the-network-device-enrollment-service-and-dependencies-for-scep-certificates-only"></a>Шаг 1. Установка и настройка службы регистрации сертификатов для сетевых устройств и зависимостей (только для сертификатов SCEP)

 Необходимо установить и настроить службу роли службы регистрации сертификатов для сетевых устройств для служб сертификатов Active Directory, изменить разрешения системы безопасности для шаблонов сертификатов, развернуть PKI-сертификат проверки подлинности клиента и внести изменения в реестр, увеличив значение максимальной длины URL-адреса IIS, используемое по умолчанию. При необходимости также необходимо настроить выдающий центр сертификации (ЦС), разрешив использование настраиваемого срока действия.  

> [!IMPORTANT]  
>  Перед настройкой Configuration Manager для работы со службой регистрации сертификатов для сетевых устройств убедитесь, что эта служба установлена и настроена. Неправильная работа зависимостей затруднит устранение неполадок при регистрации сертификатов с помощью Configuration Manager.  

### <a name="to-install-and-configure-the-network-device-enrollment-service-and-dependencies"></a>Установка и настройка службы регистрации сертификатов для сетевых устройств и зависимостей  

1. На сервере, работающем под управлением ОС Windows Server 2012 R2, установите и настройте службу роли службы регистрации сертификатов сетевых устройств для роли сервера служб сертификатов Active Directory. Дополнительные сведения см. в статье [Network Device Enrollment Service Guidance (Руководство по работе со службой регистрации сертификатов для сетевых устройств)](https://go.microsoft.com/fwlink/p/?LinkId=309016) в библиотеке служб сертификатов Active Directory в TechNet.  

2. Проверьте и, при необходимости, измените разрешения безопасности для шаблонов сертификатов, используемых службой регистрации сертификатов для сетевых устройств.  

   -   Для учетной записи, используемой для запуска консоли Configuration Manager: разрешение на **Чтение**.  

        Это разрешение требуется для того, чтобы при работе с мастером создания профилей сертификатов вы могли просмотреть и выбрать шаблон сертификата, необходимый при создании профиля параметров протокола SCEP. Выбор шаблона сертификата означает, что некоторые параметры в мастере будут заполняться автоматически. За счет этого упрощается настройка и снижается риск выбора параметров, несовместимых с шаблонами сертификатов, используемыми службой регистрации сертификатов для сетевых устройств.  

   -   Для учетной записи службы SCEP, используемой пулом приложений службы регистрации сертификатов для сетевых устройств: разрешения на **Чтение** и **Регистрацию**.  

        Это требование не относится к Configuration Manager, но используется при настройке службы регистрации сертификатов для сетевых устройств. Дополнительные сведения см. в статье [Network Device Enrollment Service Guidance (Руководство по работе со службой регистрации сертификатов для сетевых устройств)](https://go.microsoft.com/fwlink/p/?LinkId=309016) в библиотеке служб сертификатов Active Directory в TechNet.  

   > [!TIP]  
   >  Чтобы определить, какие шаблоны сертификатов используются службой регистрации сертификатов для сетевых устройств, просмотрите следующий раздел реестра на сервере, на котором работает эта служба: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\MSCEP.  

   > [!NOTE]  
   >  Разрешения безопасности, используемые по умолчанию, подходят для большинства сред. Однако можно использовать и другую конфигурацию безопасности. Дополнительные сведения см. в статье о [планировании разрешений шаблонов сертификатов для профилей сертификатов](../../protect/plan-design/planning-for-certificate-template-permissions.md).  

3. Разверните на этом сервере PKI-сертификат, который поддерживает проверку подлинности клиента. На вашем компьютере уже может быть установлен подходящий для использования сертификат, либо его необходимо (или желательно) развернуть специально для этой цели. Дополнительные сведения о требованиях, предъявляемых к этому сертификату, см. в подразделе "Серверы, на которых работает модуль политики Configuration Manager, со службой роли службы регистрации сертификатов для сетевых устройств" в разделе **Сертификаты PKI для серверов** статьи [Требования к PKI-сертификатам для Configuration Manager](../../core/plan-design/network/pki-certificate-requirements.md).  

   > [!TIP]
   >  Дополнительные сведения по развертыванию этого сертификата см. в инструкциях раздела [Развертывание сертификата клиента для точек распространения](../../core/plan-design/network/example-deployment-of-pki-certificates.md#BKMK_clientdistributionpoint2008_cm2012), поскольку требования к сертификатам совпадают, за исключением приведенного ниже пункта.  
   > 
   > - Не устанавливайте флажок **Разрешить экспортировать закрытый ключ** на вкладке **Обработка запроса** в свойствах шаблона сертификата.  
   > 
   >   Необходимость экспорта этого сертификата с закрытым ключом отсутствует, так как вы можете просмотреть хранилище локального компьютера и выбрать сертификат при настройке модуля политики Configuration Manager.  

4. Найдите корневой сертификат, с которым будет связан сертификат проверки подлинности клиента. Затем экспортируйте этот сертификат корневого ЦС в CER-файл сертификата. Сохраните этот файл в надежном месте, к которому можно получить безопасный доступ при последующей установке и настройке сервера системы сайта для точки регистрации сертификатов.  

5. На этом же сервере используйте редактор реестра, чтобы увеличить максимальную длину URL-адреса IIS, установив следующие значения DWORD разделов реестра в HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\HTTP\Parameters.  

   - Задайте для раздела **MaxFieldLength** значение **65534**.  

   - Задайте для раздела **MaxRequestBytes** значение **16777216**.  

     Дополнительные сведения см. в статье [820129. Параметры реестра HTTP.sys для Windows](https://go.microsoft.com/fwlink/?LinkId=309013) в базе знаний Майкрософт.  

6. На этом же самом сервере в диспетчере служб IIS измените параметры фильтрации запросов для приложения /certsrv/mscep, а затем перезапустите сервер. В диалоговом окне **Изменение параметров фильтрации запросов** параметры **Ограничения запросов** должны быть настроены следующим образом.  

   - **Максимально допустимая длина содержимого (в байтах)** : **30000000**  

   - **Максимальная длина URL-адреса (в байтах)** : **65534**  

   - **Максимальная длина строки запроса (в байтах)** : **65534**  

     Дополнительные сведения об этих параметрах и их настройке см. в статье [Requests Limits (Ограничения запросов)](https://go.microsoft.com/fwlink/?LinkId=309014) в справочной библиотеке IIS.  

7. Если необходимо обеспечить возможность запроса сертификата с меньшим сроком действия, чем в используемом шаблоне сертификата, то по умолчанию эта конфигурация отключена для ЦС предприятия. Чтобы включить эту возможность в ЦС предприятия, используйте программу командной строки Certutil, а затем остановите и перезапустите службу сертификатов с помощью следующих команд:  

   1. **certutil - setreg Policy\EditFlags +EDITF_ATTRIBUTEENDDATE**  

   2. **net stop certsvc**  

   3. **net start certsvc**  

      Дополнительные сведения см. в статье [Certificate Services Tools and Settings (Средства и параметры служб сертификатов)](https://go.microsoft.com/fwlink/p/?LinkId=309015) в библиотеке технологий PKI на веб-сайте TechNet.  

8. Удостоверьтесь, что служба регистрации сертификатов для сетевых устройств работает, используя в качестве примера следующую ссылку: **https://server.contoso.com/certsrv/mscep/mscep.dll** . Должна отобразиться встроенная веб-страница службы регистрации сертификатов для сетевых устройств. Эта страница содержит сведения о службе и о том, что сетевые устройства используют URL-адрес для отправки запросов на сертификаты.  

   После настройки службы регистрации сертификатов для сетевых устройств и зависимостей можно установить и настроить точку регистрации сертификатов.


## <a name="step-2---install-and-configure-the-certificate-registration-point"></a>Шаг 2. Установка и настройка точки регистрации сертификатов

Необходимо установить и настроить по крайней мере одну точку регистрации сертификатов в иерархии Configuration Manager. Эта роль системы сайта может быть установлена на сайте центра администрирования или на первичном сайте.  

> [!IMPORTANT]  
>  Перед установкой точки регистрации сертификатов ознакомьтесь с требованиями к операционной системе и зависимостями для точки регистрации сертификатов в разделе о **требованиях к системе сайта** статьи [Поддерживаемые конфигурации для System Center Configuration Manager](../../core/plan-design/configs/supported-configurations.md).  

##### <a name="to-install-and-configure-the-certificate-registration-point"></a>Процедура установки и настройки точки регистрации сертификатов  

1. В консоли Configuration Manager щелкните **Администрирование**.  

2. В рабочей области **Администрирование** разверните узел **Конфигурация сайта**, щелкните **Серверы и роли системы сайта**, а затем выберите сервер, который требуется использовать для точки регистрации сертификатов.  

3. На вкладке **Главная** в группе **Сервер** щелкните **Добавить роли системы сайта**.  

4. На странице **Общие** укажите общие параметры для системы сайта и нажмите кнопку **Далее**.  

5. На странице **Прокси-сервер** нажмите кнопку **Далее**. Точка регистрации сертификатов не использует параметры прокси-сервера Интернета.  

6. На странице **Выбор системной роли** в списке доступных ролей выберите **Точка регистрации сертификатов** и нажмите кнопку **Далее**. 

7. На странице **Режим регистрации сертификата** укажите режим для точки регистрации сертификатов: **Обрабатывать запросы на SCEP-сертификаты** или **Обрабатывать запросы на PFX-сертификаты**. Точка регистрации сертификатов не может обрабатывать оба типа запросов, но вы можете создать несколько точек регистрации, если намерены работать с сертификатами обоих типов.

   При обработке сертификатов PFX нужно выбрать центр сертификации Microsoft или Entrust.

8. Страница **Параметры точки регистрации сертификатов** изменяется в зависимости от типа сертификата.
   - Если вы выбрали **Обрабатывать запросы на SCEP-сертификаты**, настройте следующие параметры.
     -   **Имя веб-сайта**, **Номер порта HTTPS** и **Имя виртуального приложения** для точки регистрации сертификатов. Эти поля автоматически заполняются значениями по умолчанию. 
     -   **URL-адрес для службы регистрации сетевых устройств и сертификата корневого ЦС**. Нажмите кнопку **Добавить**, а затем в диалоговом окне **Добавление URL-адреса и сертификата корневого ЦС** укажите следующие сведения.
         - **URL-адрес для службы регистрации сертификатов сетевых устройств**: укажите URL-адрес в формате: https:// *<полное_доменное_имя_сервера>* /certsrv/mscep/mscep.dll. Например, если в качестве полного доменного имени сервера, на котором работает служба регистрации сертификатов для сетевых устройств, используется server1.contoso.com, введите **https://server1.contoso.com/certsrv/mscep/mscep.dll** .
         - **Сертификат корневого ЦС**. Найдите и выберите CER-файл сертификата, который был создан и сохранен на этапе **Шаг 1. Установка и настройка службы регистрации сертификатов для сетевых устройств и зависимостей**. Этот сертификат корневого ЦС позволяет точке регистрации сертификатов проверять сертификат проверки подлинности клиента, который будет использоваться модулем политики Configuration Manager.  

   - Если вы выбрали **Обрабатывать запросы на PFX-сертификаты**, следует настроить сведения о соединении и учетные данные для выбранного центра сертификации.

     - Чтобы выбрать Microsoft в качестве центра сертификации, щелкните **Добавить** и в диалоговом окне **Добавить центр сертификации и учетную запись** укажите следующие сведения:
         - **Имя сервера центра сертификации**. Введите имя используемого сервера центра сертификации.
         - **Учетная запись центра сертификации**. Щелкните **Задать**, чтобы выбрать или создать учетную запись с правами на регистрацию в шаблонах центра сертификации.
         - **Учетная запись для подключения к точке регистрации сертификатов**. Выберите или создайте учетную запись, которая подключает точку регистрации сертификатов к базе данных Configuration Manager. Также здесь можно использовать локальную учетную запись компьютера, на котором размещена точка регистрации сертификатов.
         - **Учетная запись публикации сертификатов в Active Directory**. Выберите или создайте учетную запись, которая будет использоваться для публикации сертификатов в объектах пользователей в Active Directory.

         - В диалоговом окне **URL-адрес для регистрации сертификатов для сетевых устройств и для сертификата корневого ЦС** укажите следующие параметры и щелкните **ОК**.  

     - Чтобы использовать Entrust в качестве центра сертификации, укажите следующие сведения:

       - **URL-адрес веб-службы MDM**
       - Учетные данные для этого URL-адреса: имя пользователя и пароль.

         Если вы используете API-интерфейс MDM для определения URL-адреса веб-службы Entrust, обязательно применяйте API-интерфейс версии не ниже 9, как показано в следующем примере:

         `https://entrust.contoso.com:19443/mdmws/services/AdminServiceV9`

         Более ранние версии API-интерфейса не поддерживают Entrust.

9. Нажмите кнопку **Далее** и завершите работу мастера.  

10. Дождитесь завершения установки, которая может занять нескольких минут, а затем убедитесь в успешной установке точки регистрации сертификатов, воспользовавшись одним из указанных ниже способов.  

    -   В рабочей области **Мониторинг** разверните узел **Состояние системы**, щелкните **Состояние компонента**и найдите сообщения о состоянии компонента **SMS_CERTIFICATE_REGISTRATION_POINT** .  

    -   На сервере системы сайта используйте файлы *<путь установки Configuration Manager\>* \Logs\crpsetup.log и *<путь установки Configuration Manager\>* \Logs\crpmsi.log. При успешной установке возвращается код завершения 0.  

    -   С помощью браузера убедитесь в возможности подключения к URL-адресу точки регистрации сертификатов, например https://server1.contoso.com/CMCertificateRegistration. Должна отобразиться страница **Ошибка сервера** для имени приложения с описанием ошибки HTTP 404.  

11. Найдите экспортированный файл сертификата для корневого ЦС, который автоматически создается точкой регистрации сертификатов на сервере первичного сайта в папке *<путь установки Configuration Manager\>* \inboxes\certmgr.box. Сохраните этот файл в надежном месте, к которому можно получить безопасный доступ при последующей установке модуля политики Configuration Manager на сервере, на котором работает служба регистрации сертификатов для сетевых устройств.  

    > [!TIP]  
    >  Этот сертификат не сразу появляется в папке. Возможно, потребуется немного подождать (например, полчаса), пока Configuration Manager скопирует файл в указанную папку.  


## <a name="step-3----install-the-configuration-manager-policy-module-for-scep-certificates-only"></a>Шаг 3. Установка модуля политики Configuration Manager (только для сертификатов SCEP)

Необходимо установить и настроить модуль политики Configuration Manager на каждом сервере, указанном на этапе **Шаг 2. Установка и настройка точки регистрации сертификатов** в свойствах точки регистрации сертификатов в поле **URL-адрес службы регистрации сетевых устройств**.  

##### <a name="to-install-the-policy-module"></a>Процедура установки модуля политики  

1. Войдите в систему сервера, на котором выполняется служба регистрации сертификатов для сетевых устройств, с учетной записью администратора домена и скопируйте следующие файлы из папки <установочный_носитель_Configuration_Manager\>\SMSSETUP\POLICYMODULE\X64 на установочном носителе Configuration Manager во временную папку:  

   -   PolicyModule.msi  

   -   PolicyModuleSetup.exe  

   Помимо этого, при наличии папки LanguagePack на установочном носителе, скопируйте эту папку и ее содержимое.  

2. Во временной папке выполните файл PolicyModuleSetup.exe, чтобы запустить мастер установки модуля политики Configuration Manager.  

3. На начальной странице мастера нажмите кнопку **Далее**, примите условия лицензии и нажмите кнопку **Далее**.  

4. На странице **Папка установки** примите предложенную по умолчанию папку установки для модуля политики или укажите альтернативную папку, а затем нажмите кнопку **Далее**.  

5. На странице **Точка регистрации сертификатов** укажите, используя полное доменное имя сервера системы сайта, URL-адрес точки регистрации сертификатов и имя виртуального приложения, которое указано в ее свойствах. Имя виртуального приложения по умолчанию — CMCertificateRegistration. Например, если полное доменное имя сервера системы сайта — server1.contoso.com и используется имя виртуального приложения по умолчанию, то укажите **https://server1.contoso.com/CMCertificateRegistration** .  

6. Примите значение порта по умолчанию **443** или укажите альтернативный номер порта, который использует точка регистрации сертификатов, затем нажмите кнопку **Далее**.  

7. На странице **Сертификат клиента для модуля политики** найдите и укажите сертификат проверки подлинности клиента, который был развернут на **Шаге 1. Установка и настройка службы регистрации сертификатов для сетевых устройств и зависимостей**, а затем щелкните **Далее**.  

8. На странице **Сертификат точки регистрации сертификатов** щелкните **Обзор** и выберите экспортированный файл сертификата корневого ЦС, выбранный и сохраненный в конце **Шага 2. Установка и настройка точки регистрации сертификатов**.  

   > [!NOTE]  
   >  Если вы ранее не сохраняли этот файл сертификата, он находится в расположении <путь установки Configuration Manager\>\inboxes\certmgr.box на сервере сайта.  

9. Нажмите кнопку **Далее** и завершите работу мастера.  

   Если необходимо удалить модуль политики Configuration Manager, используйте оснастку **Программы и компоненты** на панели управления. 

 
Итак, вы завершили все этапы настройки и теперь можете развертывать сертификаты для пользователей и устройств, создавая и развертывая профили сертификатов. Дополнительные сведения о создании профилей сертификатов см. в [этой статье](../../protect/deploy-use/create-certificate-profiles.md).  
